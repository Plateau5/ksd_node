<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>机构编辑-进件资料</title>
    {{include ("./../inc/cssSources")}}
    <link rel="stylesheet" href="{{markUri}}/static/dialog/dialog-layer.css">
    <link rel="stylesheet" href="{{markUri}}/static/css/employee/listCon.css"/>
    <link rel="stylesheet" href="{{markUri}}/static/css/organization/intoPieces.css"/>
</head>

<body>
<div id="wrapper" class="wrapper">
    <!-------- Part of header Begin -------->
    {{include ('./../inc/header')}}
    <!-------- Part of header End -------->

    <!-------- Part of main Begin -------->
    <div id="section" class="section normal_width">
        <!---- Part of slide nav Begin ---->
        {{include ('./../inc/sideNav')}}
        <!---- Part of slide nav End ---->

        <!---- Part of Main info Begin ---->
        <div id="main" class="main">
            <div class="crumbs_nav">
                <a href="{{markUri}}/supplier/organization/system" class="crumbs_item">机构管理</a>
                <a href="javascript:;" class="crumbs_item">编辑进件资料</a>
            </div>
            <div class="tab">
                <ul class="tab_list inline_block">
                    {{#if (reqParams.applyto_business.indexOf(',') !== -1 ) }}
                    <li class="tab_item type_normal active">新车</li>
                    <li class="tab_item type_others">二手车</li>
                    {{/if}}
                    {{#if (reqParams.applyto_business === 1)}}
                    <li class="tab_item type_normal active">二手车</li>
                    {{else}}
                    <li class="tab_item type_normal active">新车</li>
                    {{/if}}
                </ul>
            </div>
            <form action="" method="POST" id="form_category">
                <input type="hidden" name="type" value="1000" id="orgId">
                <div class="product_detail_box">
                    <div class="detail_about">
                        <!--start-->
                        {{#each (materialList) }}
                        <div class="detail_about_txt clearfix">
                            <div class="detail_about_lf check_all_box">
                                <div class="form_group">
                                    <input type="checkbox" class="apply_scope check_all" name="" value="0">
                                    <label class="checked check_all">{{this.type_value}}</label>
                                </div>
                            </div>
                            <div class="detail_about_rt form_container">
                                <div class="detail_about_rt_top">
                                    <div class="sentflag mar40">
                                        <input id="type2_identity_send" type="radio" class="have_system" name="type2_identity_send" value="0" checked="checked">
                                        <label for="type2_identity_send">必传</label>
                                    </div>
                                    <div class="sentflag">
                                        <input id="type2_identity_nosend" type="radio" class="have_system" name="type2_identity_send" value="1">
                                        <label for="type2_identity_nosend">非必传</label>
                                    </div>
                                </div>
                                <div class="detail_about_rt_bot">
                                    {{#each (this.mlist) }}
                                    <div class="sentflag mar20 form_group">
                                        <input id="{{this.material_id}}" type="checkbox" class="apply_scope" name="" value="{{this.material_id}}">
                                        <label for="{{this.material_id}}" class="
                                        {{#each (organizationList)}}
                                            {{#if (this.data_ids.indexOf(../material_id) !== -1)}}checked
                                            {{/if}}
                                        {{/each}}">{{this.material_name}}</label>
                                    </div>
                                    {{/each}}
                                </div>
                            </div>
                        </div>
                        {{/each}}
                        <!--end-->
                    </div>
                </div>
                <div class="btn_box clearfix create_wf_btn_box">
                    <a href="javascript:;" class="btn orange_btn confirm create_confirm category_edit_btn">保存</a>
                    <a href="javascript:;" class="btn bg_btn create_cancel category_cancel">取消</a>
                </div>
            </form>
        </div>
    </div>
</div>
</body>
{{include ('./../inc/jsSources')}}
<script src="{{markUri}}/static/dialog/dialog-layer.js" type="text/javascript" charset="UTF-8"></script>

<script>
    (function ($) {
        //取消按钮
        function categoryCancel () {
            var btn = $('.category_cancel');
            btn.off("click").on("click", function () {
                var id = $.trim($('#orgId').val());
                locationTo({
                    action : contextPath + markUri + '/supplier/organization/detail',
                    param : {
                        id : id
                    }
                });
            });
        }

        //编辑保存
        function onUpdate () {
            var savebtn = $('.category_edit_btn');
            savebtn.off("click").on("click", function () {
                submitEvent(savebtn);
            });
        }

        //提交保存
        var isVerify = false;//提交的标志位
        function submitEvent () {
            validateEmpty();
            if (isVerify) {
                var data = new FormData(document.getElementById("form_category"));
                // $.ajax({
                //     type: 'post',
                //     data : data,
                //     url : contextPath + '/api/supplier/edit',
                //     timeout : 600000,
                //     processData: false,
                //     contentType: false,
                //     beforeSend : function () {
                //         $('#loading').show();
                //     },
                //     success : function (res) {
                //         $('#loading').hide();
                //         if (res.error_code == 0) {
                //             $alert('操作成功', function () {
                //                 locationTo({
                //                     action : contextPath + markUri + '/merchants/detail',
                //                     param : {
                //                         supplier_id : merchantId,
                //                         url : LOCALURL
                //                     }
                //                 })
                //             })
                //         } else {
                //             $alert(res.error_msg);
                //             onUpdate();
                //         }
                //     },
                //     error : function () {
                //         $alert("操作失败，请稍后重试");
                //         onUpdate();
                //     }
                // })
            } else {
                onUpdate();
            }
        }

        //判断类别是否选中
        var count = 0;//类别选中个数
        function validateEmpty () {
            var requireInput;
            count = 0;
            var detail_about = $('.detail_about');
            detail_about.each(function () {
                var e = $(this);
                //只取当前显示的元素选择器
                if (e.css('display') != 'none') {
                    requireInput = e.find('label.check_all');
                }
            });

            requireInput.each(function () {
                var t = $(this);
                if (t.hasClass('checked')) {
                    isVerify = true;
                    return false;
                } else {
                    var childCheck = t.parents(".check_all_box").siblings(".form_container").find('.sentflag');
                    childCheck.each(function () {
                        var c = $(this).find('label');
                        if (c.hasClass('checked')) {
                            count++;
                        }
                    });
                }
            });
            if (count == 0) {
                $alert('请至少选中一项类别／请选择XXXXXX里面对应的资料。');
                isVerify = false;
            } else {
                isVerify = true;
            }
        }

        //监听是否全选
        function monitorSelectAll () {
            var singleCheck = $('.detail_about_rt_bot label');
            singleCheck.on('click', function () {
                var _this = $(this);
                var checkAll = _this.parents('.detail_about_txt').find('.check_all_box label');
                var categoryCheck = _this.parents('.detail_about_rt_bot').find('label');
                if (!_this.hasClass('checked')) {
                    var labels = _this.parents('.detail_about_rt_bot').find('label');
                    var count = 0;
                    for (var i = 0,len = labels.length;i < len;i++) {
                        if (labels[i].className == 'checked') {
                            count++;
                        }
                    }
                    if (count == categoryCheck.length -1) {
                        checkAll.addClass('checked');
                    } else {
                        if (checkAll.hasClass('checked')) {
                            checkAll.removeClass('checked');
                        }
                    }
                } else {
                    if (checkAll.hasClass('checked')) {
                        checkAll.removeClass('checked');
                    }
                }
            });
        }

        $(function() {
            resetCheckboxAndRadio('checkbox', ".form_group label", ".checked");
            checkAll(".check_all");
            monitorSelectAll();
            onUpdate();
            categoryCancel();
        });
    })(jQuery,undefined);
</script>

</html>