<!DOCTYPE html>
<html lang="en">
<head>
    {{include ("./../inc/cssSources")}}
    <link rel="stylesheet" href="{{markUri}}/static/css/orderDetails.css">
    <title>{{title}}</title>
</head>
<body>
<div id="wrapper" class="wrapper">
    <!-------- Part of header Begin -------->
    {{include ('./../inc/header')}}
    <!-------- Part of header End -------->

    <!-------- Part of main Begin -------->
    <div id="section" class="section normal_width">
        <!---- Part of slide nav Begin ---->
        {{include ('./../inc/sideNav')}}
        <!---- Part of slide nav End ---->
        <!---- 全部下载提交表单 ---->
        <form action="/finance/file/download" id="finance_download" method="post">
            <input id="finance_download_finance_id" value="{{finance_id}}" name="finance_id" type="hidden">
            <input id="user_name" value="{{vo.user_name}}" name="user_name" type="hidden">
            <input id="material_type" value="" name="material_type" type="hidden">
        </form>
        <!---- 不合格通知提交表单 ---->
        <form action="{{markUri}}/customer/loan/unqualified" id="picture_reason_form" method="post">
            <input id="finance_id_picture_reason" value="{{finance_id}}" name="finance_id" type="hidden">
            <input id="detail_supplier_id" value="{{vo.supplier_id}}" name="supplier_id" type="hidden">
            <input value="{{vo.user_name}}" name="user_name" type="hidden">
            <input value="{{vo.create_name}}" name="create_name" type="hidden">
            <input type="hidden" id="reason_inner" name="reason_inner" value="">
            <input type="hidden" id="carType" name="car_type" value="{{vo.car_type}}">
        </form>
        <!---- Part of Main info Begin ---->
        <div id="main" class="main">
            <div class="crumbs_nav">
                <a href="{markUri}}/customer/loan/system" class="crumbs_item">贷款管理</a>
                <a href="{{url}}" class="crumbs_item">{{navigation}}</a>
                <a href="javascript:;" class="crumbs_item">{{vo.user_name }}</a>
                <a href="javascript:;" class="crumbs_item">查看资料</a>
            </div>
            <!-- 详情tab部分 开始 -->
            <div class="details_content">
                <div class="tab">
                    <ul class="tab_list inline_block" id="query_tab">
                        <li class="tab_item type_normal {{#if (query_type === 1) }}active{{/if}}" data-queryType="1" style="border-left:0 ;"><span></span>进件资料</li>
                        {{#if (vo.status > 5 && vo.compact_type === 1 ) }}
                            <li class="tab_item type_others {{#if (query_type === 2) }}active{{/if}}" data-queryType="2"><span></span>合同资料</li>
                        {{/if}}
                        {{#if ( (vo.status > 5 && vo.compact_type === 0) || (vo.status > 9) ) }}
                            <li class="tab_item type_others {{#if (query_type === 3) }}active{{/if}}" data-queryType="3"><span></span>请款资料</li>
                        {{/if}}
                        {{#if (vo.status > 10 ) }}
                            <li class="tab_item type_others {{#if (query_type === 4) }}active{{/if}}" data-queryType="4"><span></span>归档资料</li>
                        {{/if}}
                    </ul>
                </div>
                <!-- tab切换按钮所需隐藏域  -->
                <input type="hidden" name="finance_id" id="finance_id" value="{{finance_id}}">
                <input type="hidden" id="advance_id" name="advance_id" value="{{reqParams.advance_id}}">
                <input type="hidden" name="query_type" value="{{query_type}}" id="query_type">
                <input type="hidden" name="photo_type" value="{{photo_type}}" id="photo_type">

                <!-- 开始录入按钮所需隐藏域  -->
                <input type="hidden" id="request_status" value="{{vo.request_status }}">
                <input type="hidden" id="userName" value="{{vo.user_name}}" >
                <input type="hidden" id="navigation" value="{{navigation}}">
                <input type="hidden" id="nodeUrl" value="{{url}}">

                <div class="details_item base_info">
                    <!-- 进件资料 Begin -->
                    {{#if (query_type === 1) }}
                        {{include ('./../inc/customerBasicInfo')}}
                    {{/if}}
                    <!-- 进件资料 End -->
                    <!-- 合同资料 Begin -->
                    {{#if (query_type === 2) }}
                        {{include ('./../inc/compactInfo')}}
                    {{/if}}
                    <!-- 合同资料 End -->
                    <!-- 请款资料部分 Begin -->
                    {{#if (query_type === 3) }}
                        {{include ('./../inc/requestpayoutInfo')}}
                    {{/if}}
                    <!-- 请款资料部分 End -->
                    <!-- 归档资料部分 Begin -->
                    {{#if (query_type === 4) }}
                        {{include ('./../inc/pigeonholeInfo')}}
                    {{/if}}
                    <!-- 归档资料部分 End -->
                    <!-- 详情页按钮逻辑 Begin -->
                    {{include ('./../inc/customerDetailBtn')}}
                    <!-- 详情页按钮逻辑 End -->

                </div>
            </div>
            <!-- 详情图片附件 Begin -->
            <div class="details_content">
                <div class="tab">
                    <ul class="tab_list inline_block" id="photo_tab">
                        <li class="tab_item type_normal {{#if (photo_type === 1) }}active{{/if}}" data-photoType="1" style="border-left:0;"><span></span>进件附件</li>
                        {{#if (vo.status > 5 && vo.compact_type === 1 ) }}
                            <li class="tab_item type_others {{#if (photo_type === 2) }}active{{/if}}" data-photoType="2"><span></span>合同附件</li>
                        {{/if}}
                        {{#if ( (vo.status > 5 && vo.compact_type === 0) || (vo.status > 9) ) }}
                            <li class="tab_item type_others {{#if (photo_type === 3) }}active{{/if}}" data-photoType="3"><span></span>请款附件</li>
                        {{/if}}
                        {{#if (vo.status > 10 ) }}
                            <li class="tab_item type_others {{#if (photo_type === 4) }}active{{/if}}" data-photoType="4"><span></span>归档附件</li>
                        {{/if}}
                    </ul>
                </div>
                <!-- 附件图片部分 Begin -->
                <div class="details_item">
                    {{#if (file_list.length > 0) }}
                    <div class="detail_box">
                        <ul class="img_list" id="img_list">
                            {{#each (file_list) }}
                            <a href="javascript:;" target="_blank">
                                <div class="list_item imgDetail" style="margin-top:0;" title="">
                                    <div class="detailBox img_item">
                                        <img class=" detailImgBox" data-original="{{this.thumbnail}}" src="{{this.thumbnail_120_90}}" alt="{{this.file_name}}"/>
                                    </div>
                                    <div class="img_desc nor_wrap">{{this.file_name}}</div>
                                </div>
                            </a>
                            {{/each}}
                        </ul>
                    </div>
                    <div class="detail_footer">
                        <a href="javascript:" class="customer_detail_download detail_high_btn download_file" alt="{{photo_type}}" lang="{{finance_id}}">全部下载</a>
                    </div>
                    {{else}}
                        {{include ('./../inc/empty_data')}}
                    {{/if}}
                </div>
            </div>
            <!-- 详情图片附件 End -->
            <!-- 操作记录 Begin -->
            {{include ('./../inc/operateLogs')}}
            <!-- 操作记录 End -->

        </div>
        <!---- Part of Main info End ---->
    </div>
    <!-------- Part of main End -------->

    <!-------- Part of footer Begin -------->
    <!--<div id="footer" class="footer"></div>-->
    <!-------- Part of footer End -------->
</div>
<div class="mask" style="display: none;"></div>
</body>
{{include ('./../inc/jsSources')}}
<script src="{{markUri}}/static/js/finance/img_detail.js"></script>
<script src="{{markUri}}/static/dialog/dialog-layer.js"></script>
<script src="{{markUri}}/static/js/customerService.js"></script>
<script>
    (function () {
        var currentTime = new Date().format('yyyy/MM/dd hh:mm');
        var currentPerson = document.getElementById("currentTime");
        if (currentPerson != null || currentPerson != undefined) {
            currentPerson.innerHTML = currentTime;
        }
    })(window, undefined);
    $(function () {
        viewLargeImage('#img_list');       // 查看大图
        viewLargeImage('.log_item');
        searchQueryType('#query_tab .tab_item'); //详情页资料tab页切换
        searchQueryType('#photo_tab .tab_item'); //详情页图片tab页切换
        detailAllot(); //分配任务按钮点击
        detailRequestPayOut(); //确认申请按钮点击
        detailEntering(); //开始录入按钮点击

        //发送不合格通知
        $("#picture_reason").off("click").on('click', function () {
            var finance_id = $(this).attr('lang');
            $("#finance_id_picture_reason").val(finance_id);
            $("#picture_reason_form").submit();
        });
    });

    //开始录入按钮点击
    function detailEntering() {
        var _this = $(this);
        var is_docking = _this.data('is_docking');      // 是否对接
        var loan_type = _this.data('loan_type');        // 进件类型 1-个人 2-企业
        var finance_id = $('#finance_id').val();
        var user_name = $('#userName').val().trim();
        var locationUrl = LOCALURL;
        var navigation = $('#navigation').val().trim();
        var nodeUrl = $('#nodeUrl').val().trim();
        var auditTime = $('#auditTime').val();
        var carType = $.trim($('#carType').val());
        var action = '';
        $('#entering').off("click").on('click', function () {
            if (is_docking == 1 && loan_type == 1) {
                action  = contextPath + markUri + '/docking/pingan/home';
                if (auditTime != 0) {
                    locationTo({
                        action : action,
                        param : {
                            finance_id : finance_id,
                            active : 'active',
                            url : locationUrl,
                            userName : user_name,
                            navigation : navigation,
                            nodeUrl : nodeUrl,
                            car_type : carType
                        }
                    });
                } else {
                    $.ajax({
                        type:"post",
                        url :contextPath + '/api/finance/startApplyloan',
                        dataType:"json",
                        data:{finance_id: finance_id},
                        async:false,
                        error:function(xhr,status,err){
                            alert("系统异常");
                        },
                        success:function(data){
                            if(data.error_code =='0'){
                                locationTo({
                                    action : action,
                                    param : {
                                        finance_id : finance_id,
                                        active : 'active',
                                        url : locationUrl,
                                        userName : user_name,
                                        navigation : navigation,
                                        nodeUrl : nodeUrl,
                                        car_type : carType
                                    }
                                })
                            }else{
                                alert(data.error_msg);
                            }
                        }
                    });
                }
            } else {
                action = contextPath + markUri + '/customer/loan/detail';
                $.ajax({
                    type:"post",
                    url :contextPath + '/api/finance/startApplyloan',
                    dataType:"json",
                    data:{finance_id: finance_id},
                    async:false,
                    error:function(xhr,status,err){
                        alert("系统异常");
                    },
                    success:function(data){
                        if(data.error_code =='0'){
                            locationTo({
                                action : action,
                                param : {
                                    finance_id : finance_id,
                                    active : 'active',
                                    url : locationUrl,
                                    userName : user_name,
                                    navigation : navigation,
                                    nodeUrl : nodeUrl,
                                    car_type : carType
                                }
                            })
                        }else{
                            $alert(data.error_msg);
                        }
                    }
                });
            }
        });
    }

    //分配任务按钮点击
    function detailAllot() {
        $(".toAllot").off("click").on('click', function () {
            var finance_id = $(this).attr('lang');
            locationTo({
                action : contextPath + markUri + '/customer/loan/allot',
                param : {
                    finance_id : finance_id
                }
            });
        });
    }

    //确认申请按钮点击
    function detailRequestPayOut() {
        $('#requestpayout_apply').off("click").on('click', function () {
            $(this).attr("disabled", true);
            var finance_id = $(this).attr('lang');
            $.ajax({
                type:"post",
                url :contextPath + '/api/finance/applyloan',
                dataType:"json",
                data:{finance_id: finance_id},
                async:false,
                error:function(xhr,status,err){
                    $(this).attr("disabled", false);
                    $alert("系统异常");
                },
                success:function(data){
                    if(data.error_code =='0'){
                        window.location.href = contextPath + markUri + '/customer/loan/alreadyAllot';
                    }else{
                        $(this).attr("disabled", true);
                        alert(data.error_msg);
                    }
                }
            });
        });
    }

    //详情页tab页切换
    function searchQueryType(tab_item) {
        var btn = $(tab_item);
        btn.off("click").on('click', function () {
            var _this = $(this);
            _this.addClass('active');
            if (_this.hasClass('type_normal')) {
                _this.siblings('.type_others').removeClass('active');
            } else {
                _this.siblings('.type_normal').removeClass('active');
            }
            if( _this.parent().attr('id') == 'query_tab'){
                $('#query_type').val(_this.attr('data-queryType'));
            }else{
                $('#photo_type').val(_this.attr('data-photoType'));
            }
            var finance_id = $.trim($('#finance_id').val());
            var advance_id = $.trim($('#advance_id').val());
            var query_type = $.trim($('#query_type').val());
            var photo_type = $.trim($('#photo_type').val());
            locationTo({
                action : contextPath +'{{detailUrl}}',
                param : {
                    finance_id : finance_id,
                    advance_id : advance_id,
                    query_type : query_type,
                    photo_type : photo_type
                }
            });
        });
    }
</script>
</html>
