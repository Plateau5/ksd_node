<!DOCTYPE html>
<html lang="en">
<head>
    {{include ("./../inc/cssSources")}}
    <link rel="stylesheet" href="{{markUri}}/static/dialog/dialog-layer.css"/>
    <link rel="stylesheet" href="{{markUri}}/static/css/customerDetails.css">
    <title>{{title}}</title>
    {{include ('./../inc/jsSources')}}
    <script src="{{markUri}}/static/js/finance/img_detail.js"></script>
    <script src="{{markUri}}/static/dialog/dialog-layer.js"></script>
    <script src="{{markUri}}/static/js/customerService.js"></script>
</head>
<body>
<div id="wrapper" class="wrapper">
    <!-------- Part of header Begin -------->
    {{include ('./../inc/header')}}
    <!-------- Part of header End -------->

    <!-------- Part of main Begin -------->
    <div id="section" class="section normal_width">
        <!---- Part of slide nav Begin ---->
        {{include ('./../inc/sideNav')}}
        <!---- Part of slide nav End ---->
        <!---- 全部下载提交表单 ---->
        <form action="/finance/file/download" id="finance_download" method="post">
            <input id="finance_download_finance_id" value="{{finance_id}}" name="finance_id" type="hidden">
            <input id="user_name" value="{{vo.user_name}}" name="user_name" type="hidden">
            <input id="material_type" value="" name="material_type" type="hidden">
            <input id="detail_suppliered_id" value="{{vo.supplier_id}}" name="supplier_id" type="hidden">
        </form>
        <!---- 不合格通知提交表单 ---->
        <form action="{{markUri}}/customer/loan/unqualified" id="picture_reason_form" method="post">
            <input id="finance_id_picture_reason" value="{{finance_id}}" name="finance_id" type="hidden">
            <input id="detail_supplier_id" value="{{vo.supplier_id}}" name="supplier_id" type="hidden">
            <input value="{{vo.user_name}}" name="user_name" type="hidden">
            <input value="{{vo.create_name}}" name="create_name" type="hidden">
            <input type="hidden" id="reason_inner" name="reason_inner" value="">
            <input type="hidden" id="carType" name="car_type" value="{{vo.car_type}}">
        </form>
        <!---- Part of Main info Begin ---->
        <div id="main" class="main">
            <div class="crumbs_nav">
                <a href="{{url}}" class="crumbs_item">{{description}}</a>
                <a href="{{url}}" class="crumbs_item">{{navigation}}</a>
                <a href="javascript:;" class="crumbs_item">{{vo.user_name }}</a>
                <a href="javascript:;" class="crumbs_item">查看资料</a>
            </div>
            <!-- 详情tab部分 开始 -->
            <div class="details_content">
                <div class="tab">
                    <ul class="tab_list inline_block" id="query_tab">
                        <li class="tab_item type_normal {{#if (query_type === 1) }}active{{/if}}" data-queryType="1" style="border-left:0 ;"><span></span>进件资料</li>
                        {{#if (vo.status >= 5 && vo.status !== 6 && vo.status !== 7) }}
                            <li class="tab_item type_others {{#if (query_type === 2) }}active{{/if}}" data-queryType="2"><span></span>合同资料</li>
                        {{/if}}
                        {{#if (url === markUri + '/customer/otherfund/pendingAudit') }}
                            {{#if ( (vo.status >= 5 && vo.compact_type === 0) || (vo.status >= 9) ) }}
                                <li class="tab_item type_others {{#if (query_type === 3) }}active{{/if}}" data-queryType="3"><span></span>请款资料</li>
                            {{/if}}
                        {{else}}
                            {{#if ( (vo.status >= 5 && vo.compact_type === 0) || (vo.status > 9) ) }}
                                <li class="tab_item type_others {{#if (query_type === 3) }}active{{/if}}" data-queryType="3"><span></span>请款资料</li>
                            {{/if}}
                        {{/if}}
                        {{#if (vo.status > 10 ) }}
                            <li class="tab_item type_others {{#if (query_type === 4) }}active{{/if}}" data-queryType="4"><span></span>归档资料</li>
                        {{/if}}
                    </ul>
                </div>
                <!-- tab切换按钮所需隐藏域  -->
                <input type="hidden" name="finance_id" id="finance_id" value="{{finance_id}}">
                <input type="hidden" id="advance_id" name="advance_id" value="{{reqParams.advance_id}}">
                <input type="hidden" name="query_type" value="{{query_type}}" id="query_type">
                <input type="hidden" name="photo_type" value="{{photo_type}}" id="photo_type">
                <input type="hidden" name="present_id" value="{{present_id}}" id="present_id">
                <input type="hidden" name="responsible" value="{{vo.responsible}}" id="responsible">
                <input type="hidden" name="jizhi_preId" value="{{vo.jizhi_preId}}" id="JZpreId">
                <input type="hidden" name="pre_id" value="{{vo.pre_id}}" id="PApreId">
                <input id="finance_type" value="{{reqParams.finance_type}}" name="finance_type" type="hidden">

                <!--本次提交材料-->
                <input type="hidden" id="materialIds" value="{{haveMaterial.material_ids }}">
                <input type="hidden" id="passMaterialIds" value="{{haveMaterial.pass_material_ids}}" >
                <input type="hidden" id="materialIdTotal" value="{{materialIds }}">
                <input type="hidden" id="materialName" value="{{materialName}}" >

                <!-- 开始录入按钮所需隐藏域  -->
                <input type="hidden" id="request_status" value="{{vo.request_status }}">
                <input type="hidden" id="userName" value="{{vo.user_name}}" >
                <input type="hidden" id="navigation" value="{{navigation}}">
                <input type="hidden" id="nodeUrl" value="{{url}}">
                <input type="hidden" id="auditTime" value="{{vo.start_audit_time}}">
                <input type="hidden" id="is_docking" value="{{vo.is_docking }}">
                <input type="hidden" id="loan_type" value="{{vo.loan_type}}" >
                <input type="hidden" id="deliver_no" value="{{haveMaterial.deliver_no}}" >
                <!-- 重新通知结果隐藏域  -->
                <input type="hidden" id="showButton" value="{{show_button}}">
                <div class="details_item base_info">
                        <!-- 进件资料 Begin -->
                        {{#if (query_type === 1) }}
                            {{include ('./../inc/customerBasicInfo')}}
                        {{/if}}
                        <!-- 进件资料 End -->
                        <!-- 合同资料 Begin -->
                        {{#if (query_type === 2) }}
                            {{include ('./../inc/compactInfo')}}
                        {{/if}}
                        <!-- 合同资料 End -->
                        <!-- 请款资料部分 Begin -->
                        {{#if (query_type === 3) }}
                            {{include ('./../inc/requestpayoutInfo')}}
                        {{/if}}
                        <!-- 请款资料部分 End -->
                        <!-- 归档资料部分 Begin -->
                        {{#if (query_type === 4) }}
                            {{include ('./../inc/pigeonholeInfo')}}
                        {{/if}}
                        <!-- 归档资料部分 End -->
                        <!-- 详情页按钮逻辑 Begin -->
                            {{include ('./../inc/customerDetailBtn')}}
                        <!-- 详情页按钮逻辑 End -->
                </div>
            </div>
            <!-- 详情图片附件 Begin -->
            <div class="details_content">
                <div class="tab">
                    <ul class="tab_list inline_block" id="photo_tab">
                        <li class="tab_item type_normal {{#if (photo_type === 1) }}active{{/if}}" data-photoType="1" style="border-left:0;"><span></span>进件附件</li>
                        {{#if (vo.status >= 5 && vo.status !== 6 && vo.status !== 7) }}
                            <li class="tab_item type_others {{#if (photo_type === 2) }}active{{/if}}" data-photoType="2"><span></span>合同附件</li>
                        {{/if}}
                        {{#if (url === markUri + '/customer/otherfund/pendingAudit') }}
                            {{#if ( (vo.status >= 5 && vo.compact_type === 0) || (vo.status >= 9) ) }}
                                <li class="tab_item type_others {{#if (photo_type === 3) }}active{{/if}}" data-photoType="3"><span></span>请款附件</li>
                            {{/if}}
                        {{else}}
                            {{#if ( (vo.status >= 5 && vo.compact_type === 0) || (vo.status > 9) ) }}
                                <li class="tab_item type_others {{#if (photo_type === 3) }}active{{/if}}" data-photoType="3"><span></span>请款附件</li>
                            {{/if}}
                        {{/if}}
                        {{#if (vo.status > 10 ) }}
                            <li class="tab_item type_others {{#if (photo_type === 4) }}active{{/if}}" data-photoType="4"><span></span>归档附件</li>
                        {{/if}}
                    </ul>
                </div>
                <!-- 附件图片部分 Begin -->
                <div class="details_item">
                    {{#if (file_list.length > 0) }}
                    <div class="detail_box">
                        <ul class="img_list" id="img_list">
                            {{#each (file_list) }}
                            <a href="javascript:;" target="_blank">
                                <div class="list_item imgDetail" style="margin-top:0;" title="{{this.file_name}}">
                                    <div class="detailBox img_item">
                                        <img class=" detailImgBox" data-original="{{this.thumbnail}}" src="{{this.thumbnail_120_90}}" alt="{{this.file_name}}"/>
                                        <div class="form_group photo_checkbox dis_none">
                                            <input type="checkbox" class="" name="" value="">
                                            <label class="order_label" data-id="{{this.file_id}}"></label>
                                        </div>
                                        {{#if (material_type === 3)}}
                                            <div class="photo_supply"></div>
                                        {{/if}}
                                    </div>
                                    <div class="time_desc nor_wrap">{{this.file_name}}</div>
                                    <div class="time_desc nor_wrap">{{this.create_time}}</div>
                                </div>
                            </a>
                            {{/each}}
                        </ul>
                    </div>
                    <div class="detail_footer detail_inline_footer" style="margin:10px 0 0;">
                        <div id="checkedAll" class="form_group inline_block dis_none" style="float: left;margin-left:20px;">
                            <input type="checkbox" class="" name="" value="" />
                            <label class="nor_wrap">全选</label>
                        </div>
                        {{#if ((url === (markUri + '/customer/loan/alreadyAllot') && vo.start_audit_time === 0) || (url === (markUri + '/customer/compact/pendingPass') && vo.start_compact_time === 0) || (url === (markUri + '/customer/compact/pendingPass') && vo.start_compact_time !== 0 && present_id !== vo.compact_service_id) || (url === (markUri + '/customer/requestpayout/pendingDispose') && vo.start_request_time === 0) || (url === (markUri + '/customer/requestpayout/pendingAudit') && vo.start_request_time === 0) || (url === (markUri + '/customer/approval/pendingAudit') && vo.start_request_time === 0)) }}

                        {{else}}
                            <a href="javascript:;" class="detail_high_btn download_choose" lang="{{finance_id}}" style="margin-right: 68px;">下载</a>
                            <a href="javascript:;" class="detail_high_btn download_file" lang="{{finance_id}}" style="display: none">下载选中</a>
                            <a href="javascript:;" class="detail_low_btn download_cancel" lang="{{finance_id}}" style="display: none">取消</a>
                        {{/if}}
                    </div>
                    {{else}}
                        {{include ('./../inc/empty_data')}}
                    {{/if}}
                </div>
            </div>
            <!-- 详情图片附件 End -->
            <!-- 操作记录 Begin -->
            {{include ('./../inc/operateLogs')}}
            <!-- 操作记录 End -->

        </div>
        <!---- Part of Main info End ---->
    </div>
    <!-------- Part of main End -------->

    <!-------- Part of footer Begin -------->
    <!--<div id="footer" class="footer"></div>-->
    <!-------- Part of footer End -------->
</div>
<div class="mask" style="display: none;"></div>
</body>
<script>
    var queryType = '{{query_type}}';
    var pigeonholeUrl = '{{url}}';
    var voStatus = '{{vo.status}}';
    var voStartAuditTime = '{{vo.start_audit_time}}';
    var startCompactTime = '{{vo.start_compact_time}}';
    var startRequestTime = '{{vo.start_request_time}}';
    queryType = queryType.number();
    (function () {
        var currentTime = new Date().format('yyyy/MM/dd hh:mm');
        var currentPerson = document.getElementById("currentTime");
        if (currentPerson != null || currentPerson != undefined) {
            currentPerson.innerHTML = currentTime;
        }

        // 跳转历史订单。
        function toHistoryList() {
            var btn = $('.customer_name');
            var url = contextPath + markUri + '/customer/history';
            btn.off('click').on('click', function () {
                var _this = $(this);
                var id = $.trim(_this.data('id'));
                var financeId = $.trim(_this.data('finance_id'));
                var name = $.trim(_this.data('name'));
                var crumbsNav = $('.crumbs_nav');
                var url_first = $.trim(crumbsNav.find('a').eq(0).attr('href'));
                var navigation_first = $.trim(crumbsNav.find('a').eq(0).text());
                var url_second = $.trim(crumbsNav.find('a').eq(1).attr('href'));
                var navigation_second = $.trim(crumbsNav.find('a').eq(1).text());
                locationTo({
                    action : contextPath + url,
                    param : {
                        customer_id : id,
                        finance_id : financeId,
                        user_name : name,
                        url_first : url_first,
                        navigation_first: navigation_first,
                        url_second : url_second,
                        navigation_second : navigation_second
                    }
                })
            });
        }


        /*提交按钮的点击逻辑*/
        function affirmSubmitEvent () {
            var ele = $(".affirm_submit_event");
            var finance_id = $.trim(ele.attr("lang"));
            var advance_id = ele.data('advance_id');
            if (ele.length != 0) {
                ele.off("click").on("click", function () {
                    locationTo({
                        action : contextPath + markUri + '/customer/approval/submit',
                        param : {
                            finance_id : finance_id,
                            advance_id : advance_id
                        }
                    });
                });

            }
        }

        /*已回款标记*/
        function alreadyCashed () {
            var btn = $(".already_cashed_check");
            btn.on("click", function () {
                var t = $(this);
                var finance_id = $.trim(t.attr("lang"));
                var advance_id = t.data('advance_id');
                locationTo({
                    action : contextPath + markUri + "/customer/financial/returnResult",
                    param : {
                        finance_id : finance_id,
                        advance_id : advance_id
                    }
                });
                //window.location.href = contextPath + "/financial/return/result?finance_id=" + finance_id;
            })
        }

        //确认回款按钮点击
        bindEvents("click", ".affirm_return_money", function (e) {
            var financeId = $(e.target).attr("lang");
            var advance_id = $(e.target).data("advance_id");
            dialog("open", {
                closeBtn : false,
                "title" : "确认回款",
                "button" : ["确认","取消"],
                "content" : "您确认将此订单已回款？",
                onConfirm : function (dia) {
                    affirmReturnedMoney(dia, financeId, advance_id);
                }
            });
        });
        //确认回款逻辑
        function affirmReturnedMoney (dialog, fid, advance_id) {
            var url = contextPath + "/api/financial/return";
            var data = {
                finance_id : fid,
                advance_id : advance_id
            };
            if (fid) {
                $ajax("POST", url, data, function (res) {
                    var data = eval(res);
                    if (data.error_code == 0) {
                        dialog.close();
                        //window.location.href = document.referrer;
                        window.location.href = contextPath + markUri + "/customer/financial/pendingReturn";
                    } else {
                        dialog.close();
                        $alert(res.error_msg);
                    }
                }, function () {
                    $alert("操作失败，请重新尝试");
                });
            }
        }
        affirmReturnedMoney();

        /*请款通过按钮的点击逻辑*/
        function requestpayoutPassed () {
            var ele = $(".requestpayout_passed");
            var url = contextPath + "/api/requestPayout/affirm/pass";
            ele.on("click", function (e) {
                var e = e || window.event;
                e.stopPropagation();    //阻断事件冒泡
                e.preventDefault();     //阻断默认事件
                passedEvent();
            });
            var passedEvent = function () {
                ele.off("click");
                var data = {
                    finance_id : $.trim(ele.attr("lang")),
                    advance_id : $.trim(ele.data("advance_id"))
                };
                $ajax("post", url, data, function (req) {
                    var res = eval(req);
                    if (res.error_code == 0) {
                        //操作成功后跳转到待通过列表页
                        window.location.href = contextPath +markUri + '/customer/requestpayout/pendingPass';
                    } else {
                        //alert(res.error_msg);
                        dialog("alert",{
                            title : "提醒",
                            content : res.error_msg,
                            button : [],
                            maskClose : false,
                            //css : 'font-size: 16px',
                            onConfirm : function () {
                                window.location.href = contextPath + markUri + '/customer/requestpayout/pendingPass';
                            }
                        })
                    }
                },function () {
                    $alert("网络异常，请重试");
                    ele.on("click", passedEvent);
                });
            }
        }

        /*确认提交按钮的点击逻辑*/
        function affirmSubmitThirdparty () {
            var ele = $(".affirm_submit_thirdparty");
            var url = contextPath + "/api/requestPayout/affirm/submit";
            //绑定事件
            ele.on("click", function (e) {
                var _this = $(this);
                var e = e || window.event;
                e.stopPropagation();    //阻断事件冒泡
                e.preventDefault();     //阻断默认事件
                var finance_id = $.trim(_this.attr("lang"));
                var reqType = $.trim(_this.attr("type"));
                var advance_id = $.trim(_this.data('advance_id'));
                if (reqType == 2) {
                    $alert("是否将该订单确认请款", function () {
                        affirmSubmitEvent(finance_id, reqType, advance_id);
                    });
                } else {
                    locationTo({
                        action : contextPath + markUri + "/customer/requestpayout/affirmSubmit",
                        param : {
                            finance_id : finance_id,
                            type : reqType,
                            advance_id : advance_id
                        }
                    });
                }
            });

            //确定请款的点击逻辑
            var affirmSubmitEvent  = function (a, b, c) {
                ele.off("click");
                var datas = {
                    finance_id : a,
                    type : b,
                    advance_id : c
                };
                $.ajax({
                    type : "post",
                    url : url,
                    data : datas,
                    async : true,
                    success : function (req) {
                        var res = eval(req);
                        if (res.error_code == 0) {
                            //更改显示按钮
                            //t.hide().siblings(".requestpayout_passed").show();
                            window.location.href = contextPath + markUri + "/customer/requestpayout/pass";
                        } else {
                            $alert(res.error_msg);
                            ele.on("click", affirmSubmitEvent);
                        }
                    },
                    error : function () {
                        $alert("网络异常，请重试");
                        ele.on("click", affirmSubmitEvent);
                    }
                });
            }

        }

        // 补全资料按钮跳转
        function complementDatumEvent () {
            var btn = $(".complement_datum");
            btn.off("click").on("click", function () {
                var _this = $(this);
                var  financeId = $.trim(_this.attr("lang"));
                var advanceId = $.trim(_this.data('advance_id'));
                var url = contextPath + "/api/requestPayout/sendNotice";
                var data = {
                    finance_id : financeId,
                    advance_id : advanceId
                };
                $ajax("POST", url, data, function (res) {
                    var datas = eval(res);
                    if (datas.error_code == 0) {
                        //nothing to do
                        $alert('已成功通知');
                    } else {
                        $alert(datas.message);
                    }
                }, function () {
                    $alert(datas.message);
                })
            });
        }

        // 跳转查看对接详情页
        function goDockingPADetail () {
            var btn = $('#viewDockingPADetail');
            var userName = $('#userName').val();
            var navigation = $('#navigation').val();
            var nodeUrl = $('#nodeUrl').val();
            if (btn.length > 0) {
                btn.on('click', function () {
                    var _this = $(this);
                    var financeId = _this.data('id');
                    var url = _this.data('url').trim();
                    locationTo({
                        action : contextPath + url,
                        param : {
                            finance_id : financeId,
                            active : 'active',
                            url : LOCALURL,
                            userName : userName,
                            navigation : navigation,
                            nodeUrl : nodeUrl
                        }
                    })
                });
            }
        }

        //开始录入按钮点击
        function detailEntering() {
            var _this = $(this);
            var is_docking = $('#is_docking').val().trim();   // 是否对接
            var loan_type = $('#loan_type').val().trim();      // 进件类型 1-个人 2-企业
            var finance_id = $('#finance_id').val();
            var user_name = $('#userName').val().trim();
            var locationUrl = LOCALURL;
            var navigation = $('#navigation').val().trim();
            var nodeUrl = $('#nodeUrl').val().trim();
            var auditTime = $('#auditTime').val();
            var carType = $.trim($('#carType').val());
            var action = '';
            $('#entering').off("click").on('click', function () {
                if (is_docking == 1 && loan_type == 1) {
                    action  = contextPath + markUri + '/docking/pingan/home';
                    if (auditTime != 0) {
                        locationTo({
                            action : action,
                            param : {
                                finance_id : finance_id,
                                active : 'active',
                                url : locationUrl,
                                userName : user_name,
                                navigation : navigation,
                                nodeUrl : nodeUrl,
                                car_type : carType
                            }
                        });
                    } else {
                        $.ajax({
                            type:"post",
                            url :contextPath + '/api/finance/startApplyloan',
                            dataType:"json",
                            data:{finance_id: finance_id},
                            async:false,
                            error:function(xhr,status,err){
                                alert("系统异常");
                            },
                            success:function(data){
                                if(data.error_code =='0'){
                                    locationTo({
                                        action : action,
                                        param : {
                                            finance_id : finance_id,
                                            active : 'active',
                                            url : locationUrl,
                                            userName : user_name,
                                            navigation : navigation,
                                            nodeUrl : nodeUrl,
                                            car_type : carType
                                        }
                                    })
                                }else{
                                    alert(data.error_msg);
                                }
                            }
                        });
                    }
                } else {
                    action = contextPath + markUri + '/customer/loan/detail';
                    $.ajax({
                        type:"post",
                        url :contextPath + '/api/finance/startApplyloan',
                        dataType:"json",
                        data:{finance_id: finance_id},
                        async:false,
                        error:function(xhr,status,err){
                            alert("系统异常");
                        },
                        success:function(data){
                            if(data.error_code =='0'){
                                locationTo({
                                    action : action,
                                    param : {
                                        finance_id : finance_id,
                                        active : 'active',
                                        url : locationUrl,
                                        userName : user_name,
                                        navigation : navigation,
                                        nodeUrl : nodeUrl,
                                        car_type : carType
                                    }
                                })
                            }else{
                                $alert(data.error_msg);
                            }
                        }
                    });
                }
            });
        }

        //分配任务按钮点击
        function detailAllot() {
            $(".toAllot").off("click").on('click', function () {
                var finance_id = $(this).attr('lang');
                locationTo({
                    action : contextPath + markUri + '/customer/loan/allot',
                    param : {
                        finance_id : finance_id
                    }
                });
            });
        }

        //确认申请按钮点击
        function detailRequestPayOut() {
            $('#requestpayout_apply').off("click").on('click', function () {
                $(this).attr("disabled", true);
                var finance_id = $(this).attr('lang');
                $.ajax({
                    type:"post",
                    url :contextPath + '/api/finance/applyloan',
                    dataType:"json",
                    data:{finance_id: finance_id},
                    async:false,
                    error:function(xhr,status,err){
                        $(this).attr("disabled", false);
                        $alert("系统异常");
                    },
                    success:function(data){
                        if(data.error_code =='0'){
                            window.location.href = contextPath + markUri + '/customer/loan/alreadyAllot';
                        }else{
                            $(this).attr("disabled", true);
                            alert(data.error_msg);
                        }
                    }
                });
            });
        }

        //详情页tab页切换
        function searchQueryType(tab_item) {
            var btn = $(tab_item);
            btn.off("click").on('click', function () {
                var _this = $(this);
                $(tab_item).removeClass('active');
                _this.addClass('active');
                if( _this.parent().attr('id') === 'query_tab'){
                    $('#query_type').val(_this.attr('data-queryType'));
                }else{
                    $('#photo_type').val(_this.attr('data-photoType'));
                }
                var finance_id = $.trim($('#finance_id').val());
                var advance_id = $.trim($('#advance_id').val());
                var query_type = $.trim($('#query_type').val());
                var photo_type = $.trim($('#photo_type').val());
                var navigation = $.trim($('#navigation').val());
                var thisMaterialIds = $.trim($('#materialIds').val());
                var materialIds = $.trim($('#materialIdTotal').val());
                var materialName = $.trim($('#materialName').val());
                var financeType = $.trim($('#finance_type').val());
                var url = "{{url}}";
                locationTo({
                    action : contextPath +'{{detailUrl}}',
                    param : {
                        finance_id : finance_id,
                        advance_id : advance_id,
                        navigation : navigation,
                        url:url,
                        query_type : query_type,
                        photo_type : photo_type,
                        material_ids: materialIds,
                        material_names : materialName,
                        this_material_ids: thisMaterialIds,
                        finance_type: financeType
                    }
                });
            });
        }
        function btnClick(btn,url) {
            btn.off('click').on('click', function () {
                var pigeonhole_icon = $('.pigeonhole_icon');
                var _this = $(this);
                var financeId =$('#finance_id').val().trim();
                var pigeonholeId =$('#pigeonhole_id').val().trim();
                var agreeType =_this.data('agree_type');
                var financeStatus =$('#finance_status').val().trim();
                var advance_id = $.trim($('#advance_id').val());
                var query_type = $.trim($('#query_type').val());
                var photo_type = $.trim($('#photo_type').val());
                var thisMaterialIds = $.trim($('#materialIds').val());
                var materialIds = $.trim($('#materialIdTotal').val());
                var materialName = $.trim($('#materialName').val());
                /*var material_ids = [];
                var material_names = [];
                pigeonhole_icon.each(function () {
                    var _cur = $(this);
                    material_ids.push(_cur.data('material_id'));
                    material_names.push(_cur.data('material_name'));
                });*/
                // $('#material_ids').val(material_ids.join(','));
                /*var materialIds = material_ids.join(',');
                var materialName =material_names.join(',');*/
                var userName =$('#user_name').val().trim();
                var navigation = $('#navigation').val().trim();         // 列表页节点名称
//                var pigeonholeUrl = '{{url}}';
                locationTo({
                    action : url,
                    param : {
                        finance_id : financeId,
                        pigeonhole_id : pigeonholeId,
                        agree_type : agreeType,
                        finance_status : financeStatus,
                        material_ids: materialIds,
                        material_names : materialName,
                        this_material_ids: thisMaterialIds,
                        user_name:userName,
                        advance_id : advance_id,
                        url : pigeonholeUrl,
                        navigation:navigation,
                        query_type : query_type,
                        photo_type : photo_type
                    }
                })
            });
        }
        // 同意按钮跳转
        function detailAgree() {
            var btn = $('#customerSubmit');
            var url = contextPath + markUri + '/customer/pigeonhole/agree';
            btnClick(btn,url);
        }
        // 不同意按钮跳转
        function detailDisagree() {
            var btn = $('#customerCancel');
            var url = contextPath + markUri + '/customer/pigeonhole/disagree';
            btnClick(btn,url);
        }
        //根据单号获取物流信息
        function deliveryNumber() {
            var deliverNo =$('#deliver_no').val().trim();
            redefineAjax({
                url : contextPath +  "/api/pigeonhole/express/list",
                data:{
                    deliver_no : deliverNo
                },
                success : function(res) {
                    if (res.error_code == 0) {
                        if( res.data && res.data.length > 0){
                            var title = res.data[0].time + " " + res.data[0].status;
                            $("#newDeliveryInfo").attr("title",title);
                        } else {
                            $("#newDeliveryInfo").attr("title","获取物流信息失败！");
                        }
                    } else if (res.error_code == 1002) {
                        $("#newDeliveryInfo").attr("title","获取物流信息失败！");
                    } else {
                        $("#newDeliveryInfo").attr("title","获取物流信息失败！");
                    }
                },
                error : function () {
                    $("#newDeliveryInfo").attr("title","获取物流信息失败！");
                }
            });
        }
        //确认归档
        bindEvents("click", ".confirm_archive", function (e) {
            var financeId = $(e.target).data("id");
            var advance_id = $(e.target).data("advance_id");
            dialog("open", {
                closeBtn : false,
                "title" : "归档提醒",
                "button" : ["确认","取消"],
                "content" : "确认将此订单归档？",
                onConfirm : function (d) {
                    d.close();
                    confirmArchive(financeId, advance_id);
                }
            });
        });
        //确认归档逻辑
        function confirmArchive (fid, advance_id) {
            var url = contextPath + "/api/requestPayout/pigeonhole";
            var data = {
                finance_id : fid,
                advance_id : advance_id
            };
            if (fid) {
                // $ajax("POST", url, data, function (res) {
                //     console.log(res);
                //     if (res.error_code == 0) {
                //         //window.location.href = document.referrer;
                //         window.location.href = contextPath + markUri + "/customer/pigeonhole/pending";
                //     } else {
                //         $alert(res.error_msg);
                //     }
                // }, function () {
                //     $alert("操作失败，请重新尝试");
                // });

                $.ajax({
                    type:'post',
                    url : url,
                    data : data,
                    beforeSend : function () {
                        $('#loading').show();
                    },
                    success : function (res) {
                        $('#loading').hide();
                        if (res.error_code == 0) {
                            window.location.href = contextPath + markUri + "/customer/pigeonhole/pending";
                        } else {
                            $alert(res.error_msg);
                        }
                    },
                    error : function () {
                        $('#loading').hide();
                        $alert("操作失败，请稍后重试");
                    }
                });
            }
        }

        function  pageJumpCheck (selector, opt) {
            var options = {};
            if (opt) {
                options = $.extend({}, opt);
            }
            var btn = $(selector);
            btn.off("click").on("click", function () {
                var present_id = $("#present_id").val().trim();
                var responsible = $("#responsible").val().trim();
                var index = responsible .lastIndexOf(",");
                var str  = responsible .substring(index + 1, responsible .length);  // 获取审批流最后一个id
                if (str === present_id) {
                    $alert("请到 '商户' - '放款管理' 下进行放款审批");
                } else {
                    var target = $(this);
                    var financeId = $.trim(target.data("id"));
                    var workflowId = $.trim(target.data("flow_id"));
                    var url = $.trim(target.data("url"));
                    var advanceId = $.trim(target.data("advance_id"));
                    financeId && (options.finance_id = financeId);
                    workflowId && (options.id = workflowId);
                    advanceId && (options.advance_id = advanceId);
                    locationTo({
                        action : url,
                        param : options
                    });
                }
            });
        }
        // 跳转预审详情
        function toPretrialDetail () {
            var btn = $(".toPretrialDetail");
            btn.off('click').on('click', function () {
                var preId = "";
                var navigation = $('#navigation').val();
                var nodeUrl = $('#nodeUrl').val();
                var financeId =$('#finance_id').val();
                var advance_id = $('#advance_id').val();
                var _this = $(this);
                var url = "";
                var dataId =_this.data('id');
                if (dataId) {
                    url = contextPath + markUri + '/customer/loan/PAPretrial/detail';
                    preId = $("#PApreId").val();
                } else {
                    url = contextPath + markUri + '/customer/loan/JZPretrial/detail';
                    preId = $("#JZpreId").val();
                }
                locationTo({
                    action : url,
                    param : {
                        pre_id : preId,
                        navigation : navigation,
                        url : nodeUrl,
                        finance_id : financeId,
                        advance_id : advance_id
                    }
                });
            });
        }

        /**
         *  下载按钮点击出现选择框 2018年9月17日
         *  Created by wyt on 2018年9月17日15:32:30
         */
        function downloadChoose() {
            var download_choose = $('.download_choose');
            var photo_checkbox = $('.photo_checkbox');
            var checkedAll = $('#checkedAll');
            var download_file = $('.download_file');
            var download_cancel = $('.download_cancel');
            download_choose.off('click').on('click', function () {
                photo_checkbox.show();
                checkedAll.show();
                download_file.show();
                download_cancel.show();
                download_choose.hide();
            });
            //图片附件取消按钮点击
            download_cancel.off('click').on('click', function () {
                photo_checkbox.hide();
                checkedAll.hide();
                download_file.hide();
                download_cancel.hide();
                download_choose.show();
            });
        }
        /**
         *  全选全不选 2018年9月17日
         *  Created by wyt on 2018年9月17日15:48:21
         */
        function selectAll () {
            var checkedAllLabel = $("#checkedAll");
            var orderList = $('.list_item');
            var orderLabel = orderList.find('.photo_checkbox label.order_label');     // 每个图片的复选按钮
            checkedAllLabel.on('click', function () {
                var _this = $(this);
                if(_this.hasClass('checked')){
                    orderLabel.removeClass('checked');
                    _this.removeClass('checked');
                }else{
                    orderLabel.addClass('checked');
                    _this.addClass('checked');
                }
            });
        }

        function verifyIsCheckAll () {
            var verify = false;
            var orderLabel = $('.list_item').find('.photo_checkbox label.order_label');     // 每个图片的复选按钮
            orderLabel.each(function () {
                var _this = $(this);
                if (_this.hasClass('checked')) {
                    verify = true;
                    return false;
                }
            });
            return verify;
        }

        /**
         *  下载选中图片 2018年9月17日
         *  Created by wyt on 2018年9月17日16:12:42
         */
        function download_file () {
            var btn = $('.download_file');
            btn.off('click').on('click', function () {
                var verify = verifyIsCheckAll();
                if (!verify) {
                    $alert('请勾选图片!');
                    return false;
                }
                var userNmae = $("#user_name").val();
                var photoType = $('.order_label');
                var photoTypeArr = [];
                photoType.each(function () {
                    var _this = $(this);
                    var v = _this.data('id');
                    if (_this.hasClass('checked')) {
                        photoTypeArr.push(v);
                    }
                });
                var photoDownload = photoTypeArr.join(',');
                locationTo({
                    action : 'http://download.zhihjf.cn/finance/file/download',
                    param : {
                        user_name : userNmae,
                        data : photoDownload
                    }
                });
            });
        }

        /**
         *  合同计时 2018年9月18日
         *  Created by wyt on 2018年9月18日10:03:22
         */
        function reckon_time () {
            var financeId = $('#finance_id').val();
            var btn = $('.reckon_time');
            var parameters = {
                finance_id : financeId
            };
            btn.off('click').on('click', function () {
                var _this = $(this);
                var timeId = _this.data('id');
                var advanceId = _this.data('advance_id');
                var timeUrl = '';
                if (timeId == '1') {
                    timeUrl = contextPath + '/api/compact/start';
                } else if (timeId == '2') {
                    timeUrl = contextPath + '/api/request/start';
                    parameters = {
                        finance_id : financeId,
                        advance_id : advanceId
                    };
                }
                redefineAjax({
                    url : timeUrl,
                    data : parameters,
                    success : function (res) {
                        if (res.error_code == 0) {
                            window.location.reload()
                        } else {
                            $alert(res.error_msg);
                        }
                    },
                    error : function () {
                        $alert("操作失败，请稍后重试");
                    }
                });
            });
        }


        $(function () {
            if( queryType === 4 ){
                deliveryNumber(); // 根据单号获取物流信息
            }
            toPretrialDetail();     // 跳转预审详情
            toHistoryList();        // 跳转历史订单
            if ((voStatus == 3 && voStartAuditTime == 0) || (voStatus == 8 && startCompactTime == 0) || (voStatus == 10 && startRequestTime == 0)) {

            } else {
                viewLargeImage('#img_list');       // 查看大图
            }
            viewLargeImage('.log_item');
            searchQueryType('#query_tab .tab_item'); //详情页资料tab页切换
            searchQueryType('#photo_tab .tab_item'); //详情页图片tab页切换
            detailAllot();  //分配任务按钮跳转
            detailRequestPayOut();  //确认申请按钮跳转
            detailEntering();   //开始录入按钮跳转
            pageJump("#sendAuditResult");   //通知审核结果按钮跳转
            renewSendResult("#RenewSendAuditResult");   //重新通知审核结果按钮跳转
            goDockingPADetail();    //跳转查看对接详情页
            pageJumpCheck(".go_forward_check");
            renewSendContractClick(".renew_send_contract");   //重新发送合同按钮跳转
            pageJump(".go_forward");   //同意不同意按钮跳转
            complementDatumEvent();   // 补全资料按钮跳转
            affirmSubmitThirdparty();    //确认提交按钮的点击逻辑
            requestpayoutPassed();     //请款通过按钮的点击逻辑
            affirmSubmitEvent();    //提交按钮的点击逻辑
            alreadyCashed();        //已回款点击逻辑
            detailAgree();//同意点击逻辑
            detailDisagree();//不同意点击逻辑
            resetCheckboxAndRadioNew('checkbox', ".form_group label", ".checked"); //复选框选中
            downloadChoose();  //下载按钮点击出现选择框
            selectAll();        //图片附件全选全不选
            download_file();    //图片附件下载
            reckon_time();      //合同及时





            //发送不合格通知
            $("#picture_reason").off("click").on('click', function () {
                var finance_id = $(this).attr('lang');
                $("#finance_id_picture_reason").val(finance_id);
                $("#picture_reason_form").submit();
            });

            //下载
            // $(".download_file").off("click").on('click', function () {
            //     var material_type = $(this).attr('alt');
            //     $('#material_type').val(material_type);
            //     $('#finance_download').submit();
            // });

            if($(".detail_inline_footer").find("a").length === 0){
                $(".detail_inline_footer").css("border-top","none");
            }
        });
        //重新通知结果
        function  renewSendResult (selector, opt) {
            var options = {};
            if (opt) {
                options = $.extend({}, opt);
            }
            var btn = $(selector);
            btn.off("click").on("click", function () {
                var target = $(this);
                var financeId = $.trim(target.data("id"));
                var url = $.trim(target.data("url"));
                var btnType = $('#showButton').val();
                financeId && (options.finance_id = financeId);
                options.type = btnType;
                locationTo({
                    action : url,
                    param : options
                });
            });
        }
        //重新发送合同
        function  renewSendContractClick (selector, opt) {
            var options = {};
            if (opt) {
                options = $.extend({}, opt);
            }
            var btn = $(selector);
            btn.off("click").on("click", function () {
                var target = $(this);
                var dataType =$.trim(target.data("type"));
                var financeId = $.trim(target.data("id"));
                var url = $.trim(target.data("url"));
                var list_url = "{{url}}";
                var navigation = "{{navigation}}";
                financeId && (options.finance_id = financeId);
                options.dataType = dataType;
                options.list_url = list_url;
                options.navigation = navigation;
                locationTo({
                    action : url,
                    param : options
                });
            });
        }
    })(window, undefined);
</script>
</html>