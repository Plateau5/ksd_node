<!DOCTYPE html>
<html lang="en">
<head>
    {{include ("./../inc/cssSources")}}
    <link rel="stylesheet" href="{{markUri}}/static/dialog/dialog-layer.css"/>
    <link rel="stylesheet" href="{{markUri}}/static/css/customerDetails.css">
    <title>{{title}}</title>
    {{include ('./../inc/jsSources')}}
    <script src="{{markUri}}/static/js/finance/img_detail.js"></script>
    <script src="{{markUri}}/static/dialog/dialog-layer.js"></script>
    <script src="{{markUri}}/static/js/customerService.js"></script>
</head>
<body>
<div id="wrapper" class="wrapper">
    <!-------- Part of header Begin -------->
    {{include ('./../inc/header')}}
    <!-------- Part of header End -------->

    <!-------- Part of main Begin -------->
    <div id="section" class="section normal_width">
        <!---- Part of slide nav Begin ---->
        {{include ('./../inc/sideNav')}}
        <!---- Part of slide nav End ---->
        <!---- 全部下载提交表单 ---->
        <form action="/finance/file/download" id="finance_download" method="post">
            <input id="finance_download_finance_id" value="{{finance_id}}" name="finance_id" type="hidden">
            <input id="user_name" value="{{vo.user_name}}" name="user_name" type="hidden">
            <input id="material_type" value="" name="material_type" type="hidden">
            <input id="detail_suppliered_id" value="{{vo.supplier_id}}" name="supplier_id" type="hidden">
        </form>
        <!---- 不合格通知提交表单 ---->
        <form action="{{markUri}}/customer/loan/unqualified" id="picture_reason_form" method="post">
            <input id="finance_id_picture_reason" value="{{finance_id}}" name="finance_id" type="hidden">
            <input id="detail_supplier_id" value="{{vo.supplier_id}}" name="supplier_id" type="hidden">
            <input value="{{vo.user_name}}" name="user_name" type="hidden">
            <input value="{{vo.create_name}}" name="create_name" type="hidden">
            <input type="hidden" id="reason_inner" name="reason_inner" value="">
            <input type="hidden" id="carType" name="car_type" value="{{vo.car_type}}">
        </form>
        <!---- Part of Main info Begin ---->
        <div id="main" class="main">
            <div class="crumbs_nav">
                <a href="{{markUri}}/customer/loan/system" class="crumbs_item">{{description}}</a>
                <a href="{{url}}" class="crumbs_item">{{navigation}}</a>
                <a href="javascript:;" class="crumbs_item">{{vo.user_name }}</a>
                <a href="javascript:;" class="crumbs_item">查看资料</a>
            </div>
            <!-- 详情tab部分 开始 -->
            <div class="details_content">
                <div class="tab">
                    <ul class="tab_list inline_block" id="query_tab">
                        <li class="tab_item type_normal {{#if (query_type === 1) }}active{{/if}}" data-queryType="1" style="border-left:0 ;"><span></span>进件资料</li>
                        {{#if (vo.status > 5 && vo.compact_type === 1 ) }}
                            <li class="tab_item type_others {{#if (query_type === 2) }}active{{/if}}" data-queryType="2"><span></span>合同资料</li>
                        {{/if}}
                        {{#if ( (vo.status > 5 && vo.compact_type === 0) || (vo.status > 9) ) }}
                            <li class="tab_item type_others {{#if (query_type === 3) }}active{{/if}}" data-queryType="3"><span></span>请款资料</li>
                        {{/if}}
                        {{#if (vo.status > 10 ) }}
                            <li class="tab_item type_others {{#if (query_type === 4) }}active{{/if}}" data-queryType="4"><span></span>归档资料</li>
                        {{/if}}
                    </ul>
                </div>
                <!-- tab切换按钮所需隐藏域  -->
                <input type="hidden" name="finance_id" id="finance_id" value="{{finance_id}}">
                <input type="hidden" id="advance_id" name="advance_id" value="{{reqParams.advance_id}}">
                <input type="hidden" name="query_type" value="{{query_type}}" id="query_type">
                <input type="hidden" name="photo_type" value="{{photo_type}}" id="photo_type">

                <!-- 开始录入按钮所需隐藏域  -->
                <input type="hidden" id="request_status" value="{{vo.request_status }}">
                <input type="hidden" id="userName" value="{{vo.user_name}}" >
                <input type="hidden" id="navigation" value="{{navigation}}">
                <input type="hidden" id="nodeUrl" value="{{url}}">
                <input type="hidden" id="auditTime" value="{{vo.start_audit_time}}">
                <input type="hidden" id="is_docking" value="{{vo.is_docking }}">
                <input type="hidden" id="loan_type" value="{{vo.loan_type}}" >

                <div class="details_item base_info">
                        <!-- 进件资料 Begin -->
                        {{#if (query_type === 1) }}
                            {{include ('./../inc/customerBasicInfo')}}
                        {{/if}}
                        <!-- 进件资料 End -->
                        <!-- 合同资料 Begin -->
                        {{#if (query_type === 2) }}
                            {{include ('./../inc/compactInfo')}}
                        {{/if}}
                        <!-- 合同资料 End -->
                        <!-- 请款资料部分 Begin -->
                        {{#if (query_type === 3) }}
                            {{include ('./../inc/requestpayoutInfo')}}
                        {{/if}}
                        <!-- 请款资料部分 End -->
                        <!-- 归档资料部分 Begin -->
                        {{#if (query_type === 4) }}
                            {{include ('./../inc/pigeonholeInfo')}}
                        {{/if}}
                        <!-- 归档资料部分 End -->
                        <!-- 详情页按钮逻辑 Begin -->
                            {{include ('./../inc/customerDetailBtn')}}
                        <!-- 详情页按钮逻辑 End -->
                </div>
            </div>
            <!-- 详情图片附件 Begin -->
            <div class="details_content">
                <div class="tab">
                    <ul class="tab_list inline_block" id="photo_tab">
                        <li class="tab_item type_normal {{#if (photo_type === 1) }}active{{/if}}" data-photoType="1" style="border-left:0;"><span></span>进件附件</li>
                        {{#if (vo.status > 5 && vo.compact_type === 1 ) }}
                            <li class="tab_item type_others {{#if (photo_type === 2) }}active{{/if}}" data-photoType="2"><span></span>合同附件</li>
                        {{/if}}
                        {{#if ( (vo.status > 5 && vo.compact_type === 0) || (vo.status > 9) ) }}
                            <li class="tab_item type_others {{#if (photo_type === 3) }}active{{/if}}" data-photoType="3"><span></span>请款附件</li>
                        {{/if}}
                        {{#if (vo.status > 10 ) }}
                            <li class="tab_item type_others {{#if (photo_type === 4) }}active{{/if}}" data-photoType="4"><span></span>归档附件</li>
                        {{/if}}
                    </ul>
                </div>
                <!-- 附件图片部分 Begin -->
                <div class="details_item">
                    {{#if (file_list.length > 0) }}
                    <div class="detail_box">
                        <ul class="img_list" id="img_list">
                            {{#each (file_list) }}
                            <a href="javascript:;" target="_blank">
                                <div class="list_item imgDetail" style="margin-top:0;" title="">
                                    <div class="detailBox img_item">
                                        <img class=" detailImgBox" data-original="{{this.thumbnail}}" src="{{this.thumbnail_120_90}}" alt="{{this.file_name}}"/>
                                    </div>
                                    <div class="img_desc nor_wrap">{{this.file_name}}</div>
                                </div>
                            </a>
                            {{/each}}
                        </ul>
                    </div>
                    <div class="detail_footer">
                        <a href="javascript:" class="customer_detail_download detail_high_btn download_file" alt="{{photo_type}}" lang="{{finance_id}}">全部下载</a>
                    </div>
                    {{else}}
                        {{include ('./../inc/empty_data')}}
                    {{/if}}
                </div>
            </div>
            <!-- 详情图片附件 End -->
            <!-- 操作记录 Begin -->
            {{include ('./../inc/operateLogs')}}
            <!-- 操作记录 End -->

        </div>
        <!---- Part of Main info End ---->
    </div>
    <!-------- Part of main End -------->

    <!-------- Part of footer Begin -------->
    <!--<div id="footer" class="footer"></div>-->
    <!-------- Part of footer End -------->
</div>
<div class="mask" style="display: none;"></div>
</body>
<script>
    (function () {
        var currentTime = new Date().format('yyyy/MM/dd hh:mm');
        var currentPerson = document.getElementById("currentTime");
        if (currentPerson != null || currentPerson != undefined) {
            currentPerson.innerHTML = currentTime;
        }
    })(window, undefined);
    $(function () {
        toHistoryList();        // 跳转历史订单
        viewLargeImage('#img_list');       // 查看大图
        viewLargeImage('.log_item');
        searchQueryType('#query_tab .tab_item'); //详情页资料tab页切换
        searchQueryType('#photo_tab .tab_item'); //详情页图片tab页切换
        detailAllot();  //分配任务按钮跳转
        detailRequestPayOut();  //确认申请按钮跳转
        detailEntering();   //开始录入按钮跳转
        pageJump("#sendAuditResult");   //通知审核结果按钮跳转
        goDockingPADetail();    //跳转查看对接详情页
        pageJump(".go_forward");   //同意不同意按钮跳转
        complementDatumEvent();   // 补全资料按钮跳转
        affirmSubmitThirdparty();    //确认提交按钮的点击逻辑
        requestpayoutPassed();     //请款通过按钮的点击逻辑
        affirmSubmitEvent();    //提交按钮的点击逻辑
        alreadyCashed();        //已回款点击逻辑
        getData();//同意逻辑
        //发送不合格通知
        $("#picture_reason").off("click").on('click', function () {
            var finance_id = $(this).attr('lang');
            $("#finance_id_picture_reason").val(finance_id);
            $("#picture_reason_form").submit();
        });

        //下载
        $(".download_file").click(function(){
            var material_type = $(this).attr('alt');
            $('#material_type').val(material_type);
            $('#finance_download').submit();
        });
    });

    // 跳转历史订单。
    function toHistoryList() {
        var btn = $('.customer_name');
        var url = contextPath + markUri + '/customer/history';
        btn.off('click').on('click', function () {
            var _this = $(this);
            var id = $.trim(_this.data('id'));
            var financeId = $.trim(_this.data('finance_id'));
            var name = $.trim(_this.data('name'));
            var crumbsNav = $('.crumbs_nav');
            var url_first = $.trim(crumbsNav.find('a').eq(0).attr('href'));
            var navigation_first = $.trim(crumbsNav.find('a').eq(0).text());
            var url_second = $.trim(crumbsNav.find('a').eq(1).attr('href'));
            var navigation_second = $.trim(crumbsNav.find('a').eq(1).text());
            locationTo({
                action : contextPath + url,
                param : {
                    customer_id : id,
                    finance_id : financeId,
                    user_name : name,
                    url_first : url_first,
                    navigation_first: navigation_first,
                    url_second : url_second,
                    navigation_second : navigation_second
                }
            })
        });
    }


    /*提交按钮的点击逻辑*/
    function affirmSubmitEvent () {
        var ele = $(".affirm_submit_event");
        var finance_id = $.trim(ele.attr("lang"));
        var advance_id = ele.data('advance_id');
        if (ele.length != 0) {
            ele.off("click").on("click", function () {
                locationTo({
                    action : contextPath + markUri + '/customer/approval/submit',
                    param : {
                        finance_id : finance_id,
                        advance_id : advance_id
                    }
                });
            });

        }
    }

    /*已回款标记*/
    function alreadyCashed () {
        var btn = $(".already_cashed_check");
        btn.on("click", function () {
            var t = $(this);
            var finance_id = $.trim(t.attr("lang"));
            var advance_id = t.data('advance_id');
            locationTo({
                action : contextPath + markUri + "/customer/financial/returnResult",
                param : {
                    finance_id : finance_id,
                    advance_id : advance_id
                }
            });
            //window.location.href = contextPath + "/financial/return/result?finance_id=" + finance_id;
        })
    }

    //确认回款按钮点击
    bindEvents("click", ".affirm_return_money", function (e) {
        var financeId = $(e.target).attr("lang");
        var advance_id = $(e.target).data("advance_id");
        dialog("open", {
            closeBtn : false,
            "title" : "确认回款",
            "button" : ["确认","取消"],
            "content" : "您确认将此订单已回款？",
            onConfirm : function (dia) {
                affirmReturnedMoney(dia, financeId, advance_id);
            }
        });
    });
    //确认回款逻辑
    function affirmReturnedMoney (dialog, fid, advance_id) {
        var url = contextPath + "/api/financial/return";
        var data = {
            finance_id : fid,
            advance_id : advance_id
        };
        if (fid) {
            $ajax("POST", url, data, function (res) {
                var data = eval(res);
                if (data.error_code == 0) {
                    dialog.close();
                    //window.location.href = document.referrer;
                    window.location.href = contextPath + markUri + "/customer/financial/pendingReturn";
                } else {
                    dialog.close();
                    $alert(res.error_msg);
                }
            }, function () {
                $alert("操作失败，请重新尝试");
            });
        }
    }
    affirmReturnedMoney();

    /*请款通过按钮的点击逻辑*/
    function requestpayoutPassed () {
        var ele = $(".requestpayout_passed");
        var url = contextPath + "/api/requestPayout/affirm/pass";
        ele.on("click", function (e) {
            var e = e || window.event;
            e.stopPropagation();    //阻断事件冒泡
            e.preventDefault();     //阻断默认事件
            passedEvent();
        });
        var passedEvent = function () {
            ele.off("click");
            var data = {
                finance_id : $.trim(ele.attr("lang")),
                advance_id : $.trim(ele.data("advance_id"))
            };
            $ajax("post", url, data, function (req) {
                var res = eval(req);
                if (res.error_code == 0) {
                    //操作成功后跳转到待通过列表页
                    window.location.href = contextPath +markUri + '/customer/requestpayout/pendingPass';
                } else {
                    //alert(res.error_msg);
                    dialog("alert",{
                        title : "提醒",
                        content : res.error_msg,
                        button : [],
                        maskClose : false,
                        //css : 'font-size: 16px',
                        onConfirm : function () {
                            window.location.href = contextPath + markUri + '/customer/requestpayout/pendingPass';
                        }
                    })
                }
            },function () {
                $alert("网络异常，请重试");
                ele.on("click", passedEvent);
            });
        }
    }

    /*确认提交按钮的点击逻辑*/
    function affirmSubmitThirdparty () {
        var ele = $(".affirm_submit_thirdparty");
        var url = contextPath + "/api/requestPayout/affirm/submit";
        //绑定事件
        ele.on("click", function (e) {
            var _this = $(this);
            var e = e || window.event;
            e.stopPropagation();    //阻断事件冒泡
            e.preventDefault();     //阻断默认事件
            var finance_id = $.trim(_this.attr("lang"));
            var reqType = $.trim(_this.attr("type"));
            var advance_id = $.trim(_this.data('advance_id'));
            if (reqType == 2) {
                $alert("是否将该订单确认请款", function () {
                    affirmSubmitEvent(finance_id, reqType, advance_id);
                });
            } else {
                locationTo({
                    action : contextPath + markUri + "/customer/requestpayout/affirmSubmit",
                    param : {
                        finance_id : finance_id,
                        type : reqType,
                        advance_id : advance_id
                    }
                });
            }
        });

        //确定请款的点击逻辑
        var affirmSubmitEvent  = function (a, b, c) {
            ele.off("click");
            var datas = {
                finance_id : a,
                type : b,
                advance_id : c
            };
            $.ajax({
                type : "post",
                url : url,
                data : datas,
                async : true,
                success : function (req) {
                    var res = eval(req);
                    if (res.error_code == 0) {
                        //更改显示按钮
                        //t.hide().siblings(".requestpayout_passed").show();
                        window.location.href = contextPath +"/customer/requestpayout/pass";
                    } else {
                        $alert(res.error_msg);
                        ele.on("click", affirmSubmitEvent);
                    }
                },
                error : function () {
                    $alert("网络异常，请重试");
                    ele.on("click", affirmSubmitEvent);
                }
            });
        }

    }

    // 补全资料按钮跳转
    function complementDatumEvent () {
        var btn = $(".complement_datum");
        btn.off("click").on("click", function () {
            var _this = $(this);
            var  financeId = $.trim(_this.attr("lang"));
            var advanceId = $.trim(_this.data('advance_id'));
            var url = contextPath + "/api/requestPayout/sendNotice";
            var data = {
                finance_id : financeId,
                advance_id : advanceId
            };
            $ajax("POST", url, data, function (res) {
                var datas = eval(res);
                if (datas.error_code == 0) {
                    //nothing to do
                    $alert('已成功通知');
                } else {
                    $alert(datas.message);
                }
            }, function () {
                $alert(datas.message);
            })
        });
    }

    // 跳转查看对接详情页
    function goDockingPADetail () {
        var btn = $('#viewDockingPADetail');
        var userName = $('#userName').val();
        var navigation = $('#navigation').val();
        var nodeUrl = $('#nodeUrl').val();
        if (btn.length > 0) {
            btn.on('click', function () {
                var _this = $(this);
                var financeId = _this.data('id');
                var url = _this.data('url').trim();
                locationTo({
                    action : contextPath + url,
                    param : {
                        finance_id : financeId,
                        active : 'active',
                        url : LOCALURL,
                        userName : userName,
                        navigation : navigation,
                        nodeUrl : nodeUrl
                    }
                })
            });
        }
    }

    //开始录入按钮点击
    function detailEntering() {
        var _this = $(this);
        var is_docking = $('#is_docking').val().trim();   // 是否对接
        var loan_type = $('#loan_type').val().trim();      // 进件类型 1-个人 2-企业
        var finance_id = $('#finance_id').val();
        var user_name = $('#userName').val().trim();
        var locationUrl = LOCALURL;
        var navigation = $('#navigation').val().trim();
        var nodeUrl = $('#nodeUrl').val().trim();
        var auditTime = $('#auditTime').val();
        var carType = $.trim($('#carType').val());
        var action = '';
        $('#entering').off("click").on('click', function () {
            if (is_docking == 1 && loan_type == 1) {
                action  = contextPath + markUri + '/docking/pingan/home';
                if (auditTime != 0) {
                    locationTo({
                        action : action,
                        param : {
                            finance_id : finance_id,
                            active : 'active',
                            url : locationUrl,
                            userName : user_name,
                            navigation : navigation,
                            nodeUrl : nodeUrl,
                            car_type : carType
                        }
                    });
                } else {
                    $.ajax({
                        type:"post",
                        url :contextPath + '/api/finance/startApplyloan',
                        dataType:"json",
                        data:{finance_id: finance_id},
                        async:false,
                        error:function(xhr,status,err){
                            alert("系统异常");
                        },
                        success:function(data){
                            if(data.error_code =='0'){
                                locationTo({
                                    action : action,
                                    param : {
                                        finance_id : finance_id,
                                        active : 'active',
                                        url : locationUrl,
                                        userName : user_name,
                                        navigation : navigation,
                                        nodeUrl : nodeUrl,
                                        car_type : carType
                                    }
                                })
                            }else{
                                alert(data.error_msg);
                            }
                        }
                    });
                }
            } else {
                action = contextPath + markUri + '/customer/loan/detail';
                $.ajax({
                    type:"post",
                    url :contextPath + '/api/finance/startApplyloan',
                    dataType:"json",
                    data:{finance_id: finance_id},
                    async:false,
                    error:function(xhr,status,err){
                        alert("系统异常");
                    },
                    success:function(data){
                        if(data.error_code =='0'){
                            locationTo({
                                action : action,
                                param : {
                                    finance_id : finance_id,
                                    active : 'active',
                                    url : locationUrl,
                                    userName : user_name,
                                    navigation : navigation,
                                    nodeUrl : nodeUrl,
                                    car_type : carType
                                }
                            })
                        }else{
                            $alert(data.error_msg);
                        }
                    }
                });
            }
        });
    }

    //分配任务按钮点击
    function detailAllot() {
        $(".toAllot").off("click").on('click', function () {
            var finance_id = $(this).attr('lang');
            locationTo({
                action : contextPath + markUri + '/customer/loan/allot',
                param : {
                    finance_id : finance_id
                }
            });
        });
    }

    //确认申请按钮点击
    function detailRequestPayOut() {
        $('#requestpayout_apply').off("click").on('click', function () {
            $(this).attr("disabled", true);
            var finance_id = $(this).attr('lang');
            $.ajax({
                type:"post",
                url :contextPath + '/api/finance/applyloan',
                dataType:"json",
                data:{finance_id: finance_id},
                async:false,
                error:function(xhr,status,err){
                    $(this).attr("disabled", false);
                    $alert("系统异常");
                },
                success:function(data){
                    if(data.error_code =='0'){
                        window.location.href = contextPath + markUri + '/customer/loan/alreadyAllot';
                    }else{
                        $(this).attr("disabled", true);
                        alert(data.error_msg);
                    }
                }
            });
        });
    }

    //详情页tab页切换
    function searchQueryType(tab_item) {
        var btn = $(tab_item);
        btn.off("click").on('click', function () {
            var _this = $(this);
            $(tab_item).removeClass('active');
            _this.addClass('active');
            if( _this.parent().attr('id') === 'query_tab'){
                $('#query_type').val(_this.attr('data-queryType'));
            }else{
                $('#photo_type').val(_this.attr('data-photoType'));
            }
            var finance_id = $.trim($('#finance_id').val());
            var advance_id = $.trim($('#advance_id').val());
            var query_type = $.trim($('#query_type').val());
            var photo_type = $.trim($('#photo_type').val());
            locationTo({
                action : contextPath +'{{detailUrl}}',
                param : {
                    finance_id : finance_id,
                    advance_id : advance_id,
                    query_type : query_type,
                    photo_type : photo_type
                }
            });
        });
    }
    var $submitDom = $('#customerSubmit');
    var $body = $('body');

//
    function getData() {
        $.ajax({
            type: 'POST',
            url :contextPath + '/api/pigeonhole/getFile',
            /*data: {finance_id:finance_id},*/
            success: function (data) {
                 data = {
                    material_ids : materialIds,
                    pass_material_ids : passMaterialIds
                };
                if (data.material_ids === data.pass_material_ids) {
                    $submitDom.hide();
                }
            }
        });
    }


    $submitDom.click(function() {
        /*$.ajax({
            type: 'POST',
            url :contextPath + '/api/pigeonhole/getFile',
            data: {finance_id:finance_id},
            success: function() {
                location.href = contextPath + markUri + "/customer/pigeonhole/agree";
            }
        });*/
    })
</script>
</html>
