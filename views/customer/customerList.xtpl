<!DOCTYPE html>
<html lang="en">
<head>
    {{include ("./../inc/cssSources")}}
    <link rel="stylesheet" href="{{markUri}}/static/css/customerService.css">
    <link rel="stylesheet" href="{{markUri}}/static/jedate/skin/jedate.css"/>
    <title>{{title}}</title>
</head>
<body>
<div id="wrapper" class="wrapper">
    <!-------- Part of header Begin -------->
    {{include ('./../inc/header')}}
    <!-------- Part of header End -------->

    <!-------- Part of main Begin -------->
    <div id="section" class="section normal_width">
        <!---- Part of slide nav Begin ---->
        {{include ('./../inc/sideNav')}}
        <!---- Part of slide nav End ---->

        <!---- Part of Main info Begin ---->
        <div id="main" class="main">
            {{include('./../inc/operationCategory')}}
            <form action="{{originUrl}}" method="post" id="form_search" role="form">
                <input type="hidden" name="current_page" value="{{current_page}}" id="current_page">
                {{include('./../inc/filtrate')}}
            </form>
            <div class="business_list">
                <form action="{{detailUrl}}" method="post" id="to_order_detail">
                    <input type="hidden" name="active" value="active">
                    <input type="hidden" name="finance_id" value="" id="financeId">
                    <input type="hidden" name="advance_id" value="" id="advanceId">
                    <input type="hidden" name="query_type" value="{{query_type}}" id="query_type">
                    <input type="hidden" name="photo_type" value="{{photo_type}}" id="photo_type">
                    <input type="hidden" name="description" value="{{description}}" id="description">
                    <!--<input type="hidden" name="start_loan_time" value="" id="start_loan_time">
                    <input type="hidden" name="end_loan_time" value="" id="end_loan_time">
                    <input type="hidden" name="pigeonhole_status" value="" id="pigeonholeStatus">
                    <input type="hidden" name="create_name" value="" id="createName">-->

                </form>
                {{#if (originUrl.indexOf( markUri + '/customer/otherfund') !== -1) }}
                    {{include('./../inc/otherfundOrderList')}}
                {{else}}
                    {{include('./../inc/ordersList')}}
                {{/if}}

                <!--分页部分 Begin-->

                    {{include('./../inc/paginations')}}

                <!--分页部分 End-->
            </div>



        </div>
        <!---- Part of Main info End ---->
    </div>
    <!-------- Part of main End -------->

    <!-------- Part of footer Begin -------->
    <!--<div id="footer" class="footer"></div>-->
    <!-------- Part of footer End -------->
</div>
<div class="mask" style="display: none;"></div>
</body>
{{include ('./../inc/jsSources')}}
<script src="{{markUri}}/static/jedate/jquery.jedate.min.js"></script>
<script src="{{markUri}}/static/js/customerService.js"></script>
</html>
<script>
    var emp_list = '{{emp_list}}';
    if (emp_list.length > 0 ){
        emp_list = JSON.parse(emp_list.replace(/&quot;/ig, '"'));
    }
    (function ($) {
        /**
         *  客户列表筛选逻辑 2018年5月8日16:21:14.
         */
        function searchCustomer () {
            var confirmBtn = $('.customer_search_confirm');
            var cancelBtn = $('.customer_search_cancel');
            var listForm = $('form[role="form"]');
            confirmBtn.off('click').on('click', function () {
                var _this = $(this);
                _this.off('click');
                var start_with = getCheckedFirstLetter();
                (start_with == "全部") && (start_with = '');
                start_with && listForm.append('<input type="hidden" class="filtrate_input" id="start_with" name="start_with" value="'+ start_with + '" />');
                listForm.submit();
            });
            cancelBtn.off('click').on('click', function () {
                var _this = $(this);
                _this.off('click');
                listForm.find('.filtrate_input').not('input[name="current_page"]').val('');
                listForm.find('.filtrate_select').val('');
                listForm.submit();
            });
        };
        //模糊查询
        var hideInput = $('#orderCreatorId');
        var btn = $('#createName');
        var resBox = $(".search_result");
        var resItem = $(".res_item");
        function fuzzySearch () {
            btn.on('input', function () {
                var _this = $(this);
                if (_this.val() == ''){
                    resBox.hide();
                } else{
                    resBox.show();
                    var queryObj = fuzzyQuery(emp_list);
                    showSearchResult(queryObj);
                    selectedCreate();
                }
            });

            // 订单所属人选中逻辑
            var selectedCreate = function () {
                $('.search_result .res_item').on('click', function () {
                    var _this = $(this);
                    var createId = $.trim(_this.data('id'));
                    var createName = $.trim(_this.data('name'));
                    var orderCreatorId = $.trim(_this.data('id'));
                    btn.val(createName);
                    hideInput.val(orderCreatorId);
                    resBox.hide();
                });
                $(document).bind('click',function(){
                    resBox.hide();
                });
            }
        }
        // 订单所属人的模糊查询功能
        function fuzzyQuery (res) {
            var queryStr = $.trim($('#createName').val()),
                queryArr = queryStr.split(""),
                data = res,
                resArr;
            if(queryStr) {
                for (var i = 0, len = queryArr.length; i < len; i++) {
                    resArr = [];
                    for (var k = 0; k < data.length; k++) {
                        if (data[k].name.indexOf(queryArr[i]) != -1) {
                            resArr.push(data[k]);
                        }
                    }
                    data = resArr;
                }
                return resArr;
            }
        }
        //创建模糊查询结果展示并绑定事件
        function showSearchResult (res) {
            var html = [];
            if (res == undefined || res.length == 0 || res.length == undefined) {
                return $('.search_list').html('<li style="text-align: center;">暂无数据</li>');
            } else {
                for (var i = 0, len = res.length; i < len; i++) {
                    var str = '';
                    str = '<li class="res_item"  data-id="' + res[i].id + '" data-name="' + res[i].name + '">\
                                <div class="name nowrap">' + res[i].name + '</div>\
                                <div class="p_dep nowrap">' + (res[i].account ? res[i].account : '暂无部门') + '</div>\
                            </li>'
                    html.push(str);
                    $('.search_list').html(html.join(""));
                    var orderId = '';

                }
            }
        }
        $(function() {
            //时间筛选 2018年5月8日15:39:35
            datePicker('#filtrate_date',{
                ishmsVal : false,
                maxDate : $.nowDate({DD:0}),
                choosefun : function () {return false;},
                okfun : function () {return false;},
                clearfun : function () {
                    $('#filtrate_date').val('');
                }
            });
            searchCustomer();  //搜索
            initDateStartEnd('#start_loan_time','#end_loan_time');  //日期筛选
            fuzzySearch(); //模糊查询订单所属人
            toOrderDetail();
            paginationSwitch();     // 分页切换
        });
    })(jQuery,undefined);
</script>
