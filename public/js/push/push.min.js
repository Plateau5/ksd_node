$(function($){windowInFocus();getMessagesInfo("#header_messages");workStatus()});var Cookie={set:function(name,value,expiredays,path,callback){var exdate=new Date;exdate.setDate(exdate.getDate()+expiredays);document.cookie=name+"="+escape(value)+(expiredays==null?"":";expires="+exdate.toGMTString())+";"+(path==null?"":"path="+escape(path));if(typeof callback=="function"){callback&&callback()}},del:function(name,callback){var exp=new Date;exp.setTime(exp.getTime()-1);var cval=getCookie(name);if(cval!=null){document.cookie=name+"="+cval+";expires="+exp.toGMTString()}if(typeof callback=="function"){callback&&callback()}},get:function(name,callback){if(document.cookie.length>0){var arr,reg=new RegExp("(^| )"+name+"=([^;]*)(;|$)");if(arr=document.cookie.match(reg))return arr[2];else return null}if(typeof callback=="function"){callback&&callback()}}};var WINDOWFOCUS=true;function windowInFocus(){$(window).on("focus",function(){WINDOWFOCUS=true});$(window).on("blur",function(){WINDOWFOCUS=false});return true}function getMessagesInfo(selector){if(!selector){return}else if(typeof selector!="string"){console.log("The parameters of 'selector''s type must be a string.");return}var cookieValue=Cookie.get("logininfo");var getMessages=function(){var newMessage=0;$.post(contextPath+"/api/message/getNotice?query_type=1",function(datas){var data=eval(datas);if(data.error_code==0){if(data.work_status==1){$(".work_status").addClass("work_active");$(".work_setting .working").addClass("active")}else{$(".work_status").addClass("rest_active");$(".work_setting .resting").addClass("active")}$("#header_image_url").attr("src",data.image_url);$("#header_username").html(data.name);$("#id_center").show();if(data.other_count>0){newMessage=data.other_count;$(selector).addClass("active");$(".message_count").find("span").text(data.other_count).end().show()}else if(data.other_count=="0"){$(selector).removeClass("active");$(".message_count ").hide().find("span").text("");$(".message_tip").hide().find(".count").text("")}if(data.count>"0"){var timer=setTimeout(function(){$(".message_tip").hide();clearTimeout(timer)},5e3);if(!WINDOWFOCUS){messageNotification("快收单","您有"+data.count+"条待处理事项",contextPath+"/home",contextPath+"/static/icon/kuaisd_m_logo.png")}}}else if(data.error_code==800||data.error_code==1e3||data.error_code==802||data.error_code==804){alert("登录失效，请重新登录");window.location.href=contextPath+"/login/logout"}else{console.log(data.error_msg)}});return newMessage};getMessages();setInterval(function(){getMessages()},3e5)}function messageNotification(title,showDetailInfo,href,icon){if(!!title){if(typeof title!="string"){throw new Error("The parameter of 'title''s type must be a string.");return}}else{throw new Error("The parameter of 'title' is not defined.")}if(!!showDetailInfo){if(typeof showDetailInfo!="string"){throw new Error("The parameter of 'showDetailInfo''s type must be a string.");return}}else{throw new Error("The parameter of 'showDetailInfo' is not defined.")}if(!!href){if(typeof href!="string"){throw new Error("The parameter of 'href''s type must be a string.");return}}else{throw new Error("The parameter of 'href' is not defined.")}if(!!icon){if(typeof icon!="string"){throw new Error("The parameter of 'icon''s type must be a string.");return}}else{throw new Error("The parameter of 'icon' is not defined.")}var NotificationHandler={isNotificationSupported:"Notification"in window,isPermissionGranted:function(){return Notification.permission==="granted"},requestPermission:function(){if(!this.isNotificationSupported){alert("该浏览器目前不支持消息推送，请更换Chrome浏览器打开");return}Notification.requestPermission(function(status){})},showNotification:function(){if(!this.isNotificationSupported){alert("该浏览器目前不支持消息推送，请更换Chrome浏览器打开");return}if(!this.isPermissionGranted()){this.requestPermission()}var n=new Notification(title,{tag:1,renotify:true,requireInteraction:true,icon:icon,body:showDetailInfo});n.onclick=function(){window.location.href=href;n.close()};n.onerror=function(){console.log("Notification encounters an error.")}}};return NotificationHandler.showNotification()}function bindEvents(type,selector,callback){if(!type||!selector){console.log("The parameters of 'type' or 'selector' is not defined.");return false}else{if(typeof type!="string"){console.log("The parameters of 'selector''s type must be a string.");return false}if(typeof selector!="string"){console.log("The parameters of 'selector''s type must be a string.");return false}}if(!!callback&&typeof callback!="function"){console.log("The parameters of 'callback' is not defined or it's type is not a function.")}var ele=$(selector);ele.off(type).on(type,function(e){var e=e||window.event;callback&&callback(e)})}function pageJump(selector,opt){var options={};if(opt){options=$.extend({},opt)}var btn=$(selector);btn.off("click").on("click",function(){var target=$(this);var financeId=$.trim(target.data("id"));var workflowId=$.trim(target.data("flow_id"));var url=$.trim(target.data("url"));financeId&&(options.finance_id=financeId);workflowId&&(options.id=workflowId);locationTo({action:url,param:options})})}function viewLargeImage(selector){var selectorName=selector||"#viewerImageList";var galley=$(selectorName);galley.each(function(i,t){var viewer=new Viewer(t,{url:"data-original",interval:2e3,loop:true,toolbar:{zoomIn:true,zoomOut:true,oneToOne:true,reset:true,prev:function(){viewer.prev(true)},play:true,next:function(){viewer.next(true)},rotateLeft:true,rotateRight:true,flipHorizontal:true,flipVertical:true,download:function(){var a=document.createElement("a");a.href=viewer.image.src;a.download=viewer.image.alt;document.body.appendChild(a);a.click();document.body.removeChild(a)}}})})}function workStatus(){var work_status=$(".work_status");work_status.off("click").on("click",function(e){var ev=e||window.event;ev.stopPropagation();ev.preventDefault();var _this=$(this).find(".work_setting");if(_this.is(":hidden")){_this.show()}else{_this.hide()}$(document).on("click",function(e){var ev=e||window.event;ev.stopPropagation();var target=$(ev.target);var parent=target.parents(".work_setting");if(target.hasClass("work_setting")){return false}else if(parent.length<=0){_this.hide();return true}else{return true}})});var setting_item=work_status.find(".setting_item");setting_item.each(function(){var _this=$(this);_this.off("click").on("click",function(e){var ev=e||window.event;ev.stopPropagation();ev.preventDefault();if(_this.find("a").hasClass("active")){return false}if(_this.find("a").hasClass("working")){var work_status=1}else{var work_status=0}$.ajax({type:"post",url:contextPath+"/api/employee/workstatus ",data:{work_status:work_status},async:true,timeout:5e4,success:function(res){$(".work_setting").hide();if(res.error_code==0){_this.parents(".work_setting").find("a").removeClass("active");_this.find("a").addClass("active");if(work_status==1){if(_this.parents(".work_status").hasClass("rest_active")){_this.parents(".work_status").removeClass("rest_active")}_this.parents(".work_status").addClass("work_active")}else{if(_this.parents(".work_status").hasClass("work_active")){_this.parents(".work_status").removeClass("work_active")}_this.parents(".work_status").addClass("rest_active")}}else{$alert(res.error_msg)}},error:function(){$alert("切换失败，请重试")}})})})}