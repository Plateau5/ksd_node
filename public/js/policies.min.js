function initDisabledOrReset(policy){var policiesList=policy||$(".form_options").not(".policies_temp");policiesList.each(function(){var _this=$(this);var inputs=_this.find("input");var select=_this.find("select");inputs.each(function(){var _that=$(this);var _status=_that.data("status");if(_status===1||!_status){_that.attr("disabled","disabled").data("status",2)}else if(_status===2){_that.removeAttr("disabled").data("status",1)}});select.each(function(){var t=$(this);if(t.attr("disabled")=="disabled"){t.removeAttrs("disabled")}else{t.attr("disabled","disabled")}})})}function bindPolicySubmit(){var submitBtn=$(".edit_confirm");submitBtn.off("click").on("click",function(e){var ev=e||window.event;ev.stopPropagation();ev.preventDefault();var _this=$(this);var editType=_this.parents(".form_options").data("edit_type");var parentForm=_this.parents(".policies_item").find(".policy_form");var verify=null;if(editType===0){verify=validatePolicyEmpty(parentForm);if(verify){_this.off("click");submitEvent(parentForm,_this)}}else if(editType===1){var editStatus=_this.data("status");if(editStatus===0){var editing=$(".edit_confirm.editing").not(".new");var newPolicy=$(".policies_temp");if(editing.length>0||newPolicy.length>0&&!newPolicy.is(":hidden")){$alert("当前有政策正在编辑中，请先保存后再编辑！")}else{_this.text("保存").addClass("editing").siblings(".edit_policies_cancel").show();parentForm.find(".disabled_mask").hide();_this.data("status",1)}}else{verify=validatePolicyEmpty(parentForm);if(ISMERCHANT){if(verify){_this.off("click");submitEvent(parentForm,_this)}}else{var unrepeat=checkPoliciesRepeat(parentForm);if(verify&&unrepeat){_this.off("click");submitEvent(parentForm,_this)}}}}})}function cancelEdit(){var body=$("body");body.on("click",".edit_policies_cancel",function(e){var ev=e||window.event;ev.stopPropagation();ev.preventDefault();var _this=$(this);var form=_this.parents(".policy_form");window.location.reload()})}function submitEvent(form,btn){var cityBtn=btn.parents(".policies_item").find(".add_city_btn");var checkedCity=getCheckedCitys(cityBtn);var submitIds=form.find(".cityIds");var submitNames=form.find(".cityNames");btn.off("click");var editType=form.find("input.edit_type").val().trim().number();var tipText="";if(editType===1){tipText="新建"}else if(editType===2){tipText="编辑"}submitIds.val(checkedCity.cityIds);submitNames.val(checkedCity.cityName);var formId=form.attr("id");var data=new FormData(form[0]);$.ajax({type:"post",url:EDITAPI,data:data,timeout:5e3,contentType:false,processData:false,success:function(res){if(res.error_code==0){$alert("政策"+tipText+"成功！",function(){window.location.reload()})}else{$alert(res.error_msg);bindPolicySubmit()}},error:function(){$alert("政策"+tipText+"失败，请重新提交。");bindPolicySubmit()}})}function validatePolicyEmpty(form){var checkedPeirods=form.find(".financing_period").find('input[type="checkbox"]:checked');if(checkedPeirods.length<=0){$alert("请选择融资期限");return false}var checkedRates=form.find(".policy_rates").find('input[type="checkbox"]:checked');if(checkedRates.length<=0){$alert("请选择费率");return false}var rebateType=form.find("select.rebate_type");var selectedTypee=rebateType.find("option:selected").val().number();if(selectedTypee==""){$alert("请选择返佣方式");return false}else{var rebateDetailValue=rebateType.siblings(".rebate_detail_value").find("input").not('[disabled="disabled"]');var isDetailEmpty=false;rebateDetailValue.each(function(){var _this=$(this);var v=_this.val().trim();if(v==""){isDetailEmpty=true}});if(isDetailEmpty){$alert("返佣方式的金额或是比例不能为空。");return false}}var proportionE=form.find(".proportion_input").not('[disabled="disabled"]');if(proportionE.length>0){var proportion=proportionE.val().number();if(proportion){if(proportion>100){$alert("比例不能超过100%。");return false}else{if(proportion.toString().indexOf(".")!=-1){if(proportion.toString().split(".")[1].length>2){$alert("请输入返佣比例保留两位小数。");return false}}}}else{$alert("请先填写比例，比例不能为空。");return false}}var excessAmountE=form.find(".excess_amount_input").not('[disabled="disabled"]');if(excessAmountE.length>0){var excessAmount=excessAmountE.val().number();if(excessAmount>9999999.99){$alert("超出金额不能大于9999999.99。");return false}}var returnAmountE=form.find(".return_amount").not('[disabled="disabled"]');if(returnAmountE.length>0){var returnAmount=returnAmountE.val().number();if(returnAmount>excessAmount||returnAmount>9999999.99){$alert("返还金额不能大于超出金额。");return false}}var proportion_inputE=form.find(".proportion_input").not('[disabled="disabled"]');if(proportion_inputE.length>0){var proportion_input=proportion_inputE.val();if(proportion_input.indexOf(".")!=-1){if(proportion_input.split(".")[1].length>2){$alert("请把比例控制小数点后两位。");return false}else if(proportion_input.split(".")[1].length==1){proportion_inputE.val(proportion_input+"0")}}else{proportion_inputE.val(proportion_input+".00")}}var _thisBtn=form.find(".add_city_btn");if(_thisBtn.length>0){var citys=getCheckedCitys(_thisBtn).cityIds;if(citys.length<=0){$alert("请选择至少一个城市");return false}}var checkedSupplier=form.find(".supplier_type_box").find('input[type="checkbox"]:checked');if(checkedSupplier.length<=0){$alert("请选择适用店面");return false}var effectiveDate=form.find(".effective_date").val();if(effectiveDate==""){$alert("请选择生效时间");return false}var old_effective_time=new Date($("#old_effective_time").val()).getTime();effectiveDate=new Date(effectiveDate).getTime();if(effectiveDate<old_effective_time){$alert("时间无效");return false}return true}function getCheckedCitys(btn){var citys=btn.parents(".city_box").find(".city_list .city");var cityObj={cityIds:[],cityName:[]};citys.each(function(){var _this=$(this);var v=_this.data("id");var name=_this.data("name");cityObj.cityIds.push(v);cityObj.cityName.push(name)});return cityObj}function getEditPolicyData(form){var policyData={rates:[],rebatePeriods:[],citys:[]};var ratesEle=form.find(".policy_rates").find('input[type="checkbox"]:checked');var peridosEle=form.find(".policy_periods").find('input[type="checkbox"]:checked');ratesEle.each(function(){var _this=$(this);var value=_this.val().trim().number();policyData.rates.push(value)});peridosEle.each(function(){var _this=$(this);var value=_this.val().trim().number();policyData.rebatePeriods.push(value)});var _thisBtn=form.find(".add_city_btn");policyData.citys=getCheckedCitys(_thisBtn);return policyData}function checkPoliciesRepeat(form){var editPolicyData=getEditPolicyData(form);var index=form.data("policy_index");rebatePolicies.remove(rebatePolicies[index]);for(var i=0,len=rebatePolicies.length;i<len;i++){var oldRates=rebatePolicies[i].rate.split(",");var oldPeriods=rebatePolicies[i].rebate_period.split(",");var oldCitys=rebatePolicies[i].city_ids.split(",");var oldApplicable=rebatePolicies[i].supplier_types.split(",");for(var a=0,l1=oldRates.length;a<l1;a++){if(editPolicyData.rates.indexOf(oldRates[a])!==-1){for(var b=0,l2=oldPeriods.length;b<l2;b++){if(editPolicyData.rebatePeriods.indexOf(oldPeriods[b])!==-1){for(var c=0,l3=oldCitys.length;c<l3;c++){if(editPolicyData.citys.cityIds.indexOf(oldCitys[c])!==-1){for(var d=0,l4=oldApplicable.length;d<l4;d++){if(editPolicyData.supplier_types.indexOf(oldApplicable[d])!==-1){var millionCoefficient=parseInt((oldRates[a]*100*(oldPeriods[b]/12)+1e4)/oldPeriods[b]*1e3)/1e3;if(millionCoefficient.toString().indexOf(".")!==-1){if(millionCoefficient.toString().split(".")[1].number()>445){millionCoefficient=millionCoefficient.toString().split(".")[0].number()+1}else{millionCoefficient=millionCoefficient.toString().split(".")[0].number()}}var cityName=editPolicyData.citys.cityName[c];var ApplicableName=editPolicyData.supplier_type.name[d];$alert("当前政策下"+cityName+"万元系数"+ApplicableName+millionCoefficient+"已存在！");return false}}}}}}}}}return true}function createNewPolicy(){var temp=$(".policies_temp");var firstPolicy=$(".first_policy");var createBtn=$(".create_policy_btn");var submitBtn=$(".edit_confirm");createBtn.off("click").on("click",function(){var newPolicy=temp;var time=(new Date).getTime();newPolicy.find("form.policy_form").attr("id","policyForm"+time);firstPolicy.before(temp);var newPolicy=$(".policies_temp").eq(0);newPolicy.show();newPolicy.find(".edit_delete").show();submitBtn.off("click");bindPolicySubmit()})}function deletePolicy(){var body=$("body");body.on("click",".edit_delete",function(e){var ev=e||window.event;ev.stopPropagation();ev.preventDefault();var _this=$(this);var btnBox=_this.parents(".btn_box");var btnType=btnBox.data("btn_type");var policyE=_this.parents(".form_options");if(btnType===0){window.location.reload()}else if(btnType===1){dialog("open",{closeBtn:false,title:"提醒",content:"您确认要删除该政策？",button:["确认","取消"],maskClose:false,onConfirm:function(d){d.close();deleteOldPolicies(_this,d)},onCancel:function(d){d.close()}})}})}function deleteOldPolicies(btn,d){btn.off("click");var policyE=btn.parents(".form_options");var policyId=policyE.data("id");var effectiveTime=policyE.find('input[name="effective_time"]').val().trim();var orgId=$(".orgId").val().trim().number();redefineAjax({url:contextPath+"/api/organization/policy/delete",data:{rebate_id:policyId,organization_id:orgId,effective_time:effectiveTime},success:function(res){d.close;if(res.error_code==0){$alert("政策删除成功。",function(){window.location.reload()})}else{$alert(res.error_msg);deletePolicy()}},error:function(){$alert("政策删除失败，请重新提交！");deletePolicy()}})}function backToPoliciesList(){var btn=$(".back_policies_list");btn.off("click").on("click",function(){locationTo({action:contextPath+markUri+"/supplier/organization/policies",param:{organization_id:orgId,car_type:carType,orgName:orgName,applyto_business:applytoBusiness}})})}function toPoliciesList(){var btn=$(".back_policies_list");btn.off("click").on("click",function(){var _this=$(this);locationTo({action:contextPath+markUri+"/merchants/policies/list",param:{applyto_car:mBusinessType,city_id:mCityId,city_name:cityName,supplier_id:supplierId,supplier_name:supplierName,car_type:carType,url:listUrl,navigation:navigation}})})}function toPoliciesEdit(){var btn=$(".back_policies_edit");btn.off("click").on("click",function(){locationTo({action:contextPath+markUri+"/merchants/policies/edit",param:{organization_id:orgId,car_type:carType,orgName:orgName,rebate_type:type,rebate_typeId:rebateId,rebate_name:rebateName,supplier_id:supplierId,supplier_name:supplierName,url:listUrl,navigation:navigation,city_id:mCityId,city_name:cityName,applyto_car:mBusinessType}})})}