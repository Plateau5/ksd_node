function switchStoreType(){var bType=$("#businessType").find("#carType");bType.off("change").on("change",function(){var opt=$(this).find("option:selected");var id=$.trim(opt.val());renderStore(id)});var renderStore=function(v){var storeCont=$("#storeType").find(".column_val");if(v=="0"){var elemStr=getRenderStr(storeType.newType,v)}else if(v=="1"){var elemStr=getRenderStr(storeType.oldType,v)}else if(v=="2"){var elemStr=getRenderStr(storeType.allType,v)}storeCont.html(elemStr)};var getRenderStr=function(list,businessType){var elem="";for(var i=0,len=list.length;i<len;i++){elem+='<div class="form_group mar6">\n'+'         <input id="store_type_'+(i+1)+'" type="radio" '+((businessType=="1"&&list[i].id==9?'checked="checked"':"")||(businessType!="1"&&list[i].id==4?'checked="checked"':""))+'class="" name="type" value="'+list[i].id+'" />\n'+'         <label for="store_type_'+(i+1)+'" class="checked">'+list[i].value+"</label>\n"+"    </div>"}return elem}}function getFollowPeople(){var followArr=[];var fpElem=$(".person_list .person");fpElem.each(function(){var _this=$(this);var id=$.trim(_this.data("id"));followArr.push(id)});return followArr}function switchOwnPerson(){var ownType=$("#ownType").find("#ownTypeS");var ownPerson=$("#ownPerson").find("#ownPersonInput");ownType.off("change").on("change",function(){var opt=$(this).find("option:selected");var id=$.trim(opt.val());if(id=="1"){$("#ownPerson").show();var ids=getFollowPeople();ownPerson.val(ids.join(","))}else if(id=="2"){$("#ownPerson").hide();ownPerson.val("")}})}function addOwnPerson(){var setObj={depName:$(".department_name"),mName:$(".manager_name .p_name"),btn:$("#addOwnPersonBtn"),sBox:$(".search_box"),input:$(".m_search "),resBox:$(".search_result"),personList:$(".person_list")};function searchManagers(){setObj.btn.off("click").on("click",function(e){var e=e||window.event;e.stopPropagation();var allFollow=getFollowPeople();if(allFollow.length>=20){$alert("最多添加20个拥有者");return false}setObj.sBox.is(":hidden")?setObj.sBox.show():setObj.sBox.hide();setObj.input.focus();setObj.input.off("input click").on("input click",function(e){var e=e||window.event;e.stopPropagation();var val=$.trim($(this).val());if(val){var cityId=$.trim($("#businessCity").find("option:selected").val());var queryObj=fuzzyQuery(empList);showSearchResult(queryObj)}})})}$(document).on("click",function(e){var e=e||window.event;e.stopPropagation();setObj.sBox.is(":hidden")?false:setObj.sBox.hide()});function fuzzyQuery(res){var queryStr=$.trim(setObj.input.val()),queryArr=queryStr.split(""),data=res,resArr;if(queryStr){for(var i=0,len=queryArr.length;i<len;i++){resArr=[];for(var k=0;k<data.length;k++){if(data[k].name.indexOf(queryArr[i])!=-1){resArr.push(data[k])}}data=resArr}}return resArr}function showSearchResult(res){var html=[];if(res.length==0||res.length==undefined){return setObj.resBox.html('<li class="res_item" style="text-align: center;">暂无数据</li>')}else{for(var i=0,len=res.length;i<len;i++){var str="";str='<li class="res_item" title="">'+'<span class="name nowrap" title="" data-lId="'+res[i].id+'">'+res[i].name+"</span> "+'<span class="p_dep nowrap" title="">'+(res[i].department_name?res[i].department_name:"暂无部门")+"</span> "+"</li>";html.push(str)}}setObj.resBox.html(html.join(""));var item=setObj.resBox.find(".res_item");item.each(function(){var t=$(this);t.off("click").on("click",function(e){var e=e||window.event;e.stopPropagation();var _this=$(this);var leaderEle=_this.find(".name"),pName=leaderEle.text(),lId=leaderEle.attr("data-lId");setObj.input.val("");setObj.resBox.html("");setObj.sBox.hide();var oldOwner=getFollowPeople();if(oldOwner.indexOf(lId)!=-1){$alert('"'+pName+'"已拥有此商户')}else{var ownStr='<li class="person" data-id="'+lId+'">'+pName+'<em class="delete_btn"></em></li>';setObj.personList.find(".choose_box").before(ownStr);var endPerson=getFollowPeople().join(",");$("#ownPersonInput").val(endPerson)}})})}searchManagers()}function deleteFollowPeople(){var delBtnParent=$(".person_list");delBtnParent.off("click").on("click",".delete_btn",function(){var _this=$(this);_this.parents(".person").remove();var endPerson=getFollowPeople().join(",");$("#ownPersonInput").val(endPerson)})}function deleteLinkOrRecord(){var addBtnParents=$(".merchants_edit");var deleteLinkList=[];var deleteRecordList=[];addBtnParents.on("click",".delete_sm_btn",function(e){var e=e||window.event;e.stopPropagation();e.preventDefault();var _this=$(this);var id=$.trim(_this.data("id"));var type=$.trim(_this.data("type"));var linkCount=Number($.trim($("#linkCount").val()));var recordCount=Number($.trim($("#recordCount").val()));if(type==1){if(linkCount>1){if(_this.parents(".link_option").hasClass("his_link")){var t=_this.parents(".link_option");var link={id:$.trim(t.find(".link_name").data("id")),name:$.trim(t.find(".link_name").val()),status:0,phone:$.trim(t.find(".link_phone").val()),position_id:$.trim(t.find(".position_id option:selected").val())};deleteLinkList.push(link);var oldDeleteLink=$("#deleteLinkList").val();$.merge(oldDeleteLink,deleteLinkList);$("#deleteLinkList").val(JSON.stringify(deleteLinkList))}_this.parents(".link_option").remove();linkCount-=1;$("#linkCount").val(linkCount);if(linkCount<=1){settingBtn(".link_option");$(".link_option").eq(0).find(".delete_sm_btn").remove()}else{settingBtn(".link_option")}}}else if(type==2){if(recordCount>1){if(_this.parents(".record_option").hasClass("his_record")){var t=_this.parents(".record_option");var accountUse=t.find('input.account_use[type="checkbox"][checked="checked"]');var accountUseArr=[];accountUse.each(function(){var _this=$(this);var v=_this.val().trim();accountUseArr.push(v)});var record={id:$.trim(t.find(".account_name").data("id")),account_name:$.trim(t.find(".account_name").val()),status:0,bank_no:$.trim(t.find(".bank_no").val()),open_bank:$.trim(t.find(".open_bank").val()),account_type:$.trim(t.find(".account_type option:selected").val()),account_use:accountUseArr.join(",")};deleteRecordList.push(record);var oldDeleteRecord=$("#deleteLinkList").val();$.merge(oldDeleteRecord,deleteRecordList);$("#deleteRecordList").val(JSON.stringify(deleteRecordList))}_this.parents(".record_option").remove();recordCount-=1;$("#recordCount").val(recordCount);if(recordCount<=1){settingBtn(".record_option");$(".record_option").eq(0).find(".delete_sm_btn").remove()}else{settingBtn(".record_option")}}}});var settingBtn=function(target){var item=$(target);var len=item.length;if(len<0){item.find(".delete_sm_btn").remove()}else{item.each(function(i){var _this=$(this);var addBtnCount=Number(_this.find(".btn_box").find(".add_sm_btn").length);if(target==".link_option"){_this.attr("id","linkPeople"+(i+1));if(i==0){_this.find(".options_title").text("联系人信息")}else{_this.find(".options_title").text("联系人信息("+(i+1)+")")}if(addBtnCount<1){var id=_this.find(".delete_sm_btn").data("id");if(i==len-1){_this.find(".btn_box").find(".delete_sm_btn").before('<a href="javascript:" class="add_sm_btn" data-type="1" data-id="'+id+'">添加联系人</a>')}}}else if(target==".record_option"){_this.attr("id","recordInfo"+(i+1));if(i==0){_this.find(".options_title").text("账户信息")}else{_this.find(".options_title").text("账户信息("+(i+1)+")")}if(addBtnCount<1){var id=_this.find(".delete_sm_btn").data("id");if(i==len-1){_this.find(".btn_box").find(".delete_sm_btn").before('<a href="javascript:" class="add_sm_btn" data-type="2" data-id="'+id+'">添加账户</a>')}}}})}}}function addLinkOrRecord(){var addBtnParents=$(".merchants_edit");addBtnParents.on("click",".add_sm_btn",function(e){var e=e||window.event;e.stopPropagation();e.preventDefault();var _this=$(this);var id=$.trim(_this.data("id"));var type=$.trim(_this.data("type"));var linkCount=Number($.trim($("#linkCount").val()));var recordCount=Number($.trim($("#recordCount").val()));if(type==1){var timestamp=(new Date).getTime();var linkStr='<div class="form_content form_options merchants_create link_option new_link" id="linkPeople'+(linkCount+1)+'">\n'+'                    <form action="" class="basic_info_edit">\n'+"                        \x3c!-- 联系人信息 Begin --\x3e\n"+'                        <div class="options_title">联系人信息('+(Number(linkCount)+1)+")</div>\n"+'                        <div class="option_item">\n'+'                            <div class="column_name">\n'+'                                <span class="options_name"><span class="require_icon">*</span>姓&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;名：</span>\n'+"                            </div>\n"+'                            <div class="column_val">\n'+'                                <input type="text"   class="requireTrue link_name" data-text="联系人姓名" maxlength="20"  value="" placeholder="请输入联系人姓名"  />\n'+'                                <span class="tips_info">(*请输入联系人名称)</span>\n'+"                            </div>\n"+"                        </div>\n"+'                        <div class="option_item">\n'+'                            <div class="column_name">\n'+'                                <span class="options_name"><span class="require_icon">*</span>手&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;机：</span>\n'+"                            </div>\n"+'                            <div class="column_val">\n'+'                                <input type="text"  oninput="checkNum($(this));" class="requireTrue link_phone" data-text="手机" maxlength="11" value="" placeholder="请输入手机号码"  />\n'+'                                <span class="tips_info">(*请输入手机号)</span>\n'+"                            </div>\n"+"                        </div>\n"+'                        <div class="option_item">\n'+'                            <div class="column_name">\n'+'                                <span class="options_name"><span class="require_icon">*</span>职&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;务：</span>\n'+"                            </div>\n"+'                            <div class="column_val">\n'+'                                <select name=""  class="position_id">\n'+'                                    <option value="8" selected="selected">店长</option>\n'+'                                    <option value="6">门店经理</option>\n'+'                                    <option value="7">销售主管</option>\n'+'                                    <option value="9">销售专员</option>\n'+"                                </select>\n"+"                            </div>\n"+"                        </div>\n"+"                    </form>\n"+'                    <div class="btn_box text_left clearfix">\n'+'                        <a href="javascript:" class="add_sm_btn" data-type="1" data-id="'+timestamp+'">添加联系人</a>\n'+'                        <a href="javascript:" class="delete_sm_btn" data-type="1" data-id="'+timestamp+'">删除联系人</a>\n'+"                    </div>\n"+"                </div>";$("#linkPeople"+linkCount).after(linkStr);linkCount+=1;$("#linkCount").val(linkCount);initDateAll(".birthday.new_birthday");settingBtn(".link_option")}else if(type==2){var timestamp=(new Date).getTime();var recordStr='<div class="form_content form_options merchants_create record_option new_record" id="recordInfo'+(recordCount+1)+'">\n'+'                    <form action="" class="basic_info_edit">\n'+"                        \x3c!-- 证件信息 Begin --\x3e\n"+'                        <div class="options_title">账户信息('+(Number(recordCount)+1)+")</div>\n"+'                        <div class="option_item">\n'+'                            <div class="column_name">\n'+'                                <span class="options_name"><span class="require_icon">*</span>账户类型：</span>\n'+"                            </div>\n"+'                            <div class="column_val">\n'+'                                <select name=""  class="account_type">\n'+'                                    <option value="1" selected="selected">公户</option>\n'+'                                    <option value="2">法人</option>\n'+'                                    <option value="3">其他合伙人</option>\n'+'                                    <option value="4">其他人员</option>\n'+"                                </select>\n"+"                            </div>\n"+"                        </div>\n"+'                        <div class="option_item">\n'+'                            <div class="column_name">\n'+'                               <em class="require_icon">*</em>\n'+'                                <span class="options_name">账户用途：</span>\n'+"                            </div>\n"+'                               <div class="column_val">\n'+'                                    <div class="form_group">\n'+'                                        <input id="account_use1" type="checkbox" class="account_use" name="account_use"  value="1" />\n'+'                                        <label for="account_use1">车款</label>\n'+"                                    </div>\n"+'                                    <div class="form_group">\n'+'                                        <input id="account_use2" type="checkbox" class="account_use" name="account_use" value="2" />\n'+'                                        <label for="account_use2">返点</label>\n'+"                                    </div>\n"+'                                    <div class="form_group">\n'+'                                        <input id="account_use3" type="checkbox" class="account_use" name="account_use" value="3" />\n'+'                                        <label for="account_use3">杂费</label>\n'+"                                    </div>\n"+"                                </div>\n"+"                            </div>\n"+'                        <div class="option_item">\n'+'                            <div class="column_name">\n'+'                                <span class="options_name"><span class="require_icon">*</span>账&nbsp;户&nbsp;名：</span>\n'+"                            </div>\n"+'                            <div class="column_val">\n'+'                                <input type="text" value="" class="requireTrue account_name" data-text="账户名" maxlength="30" placeholder="请输入账户名" />\n'+'                                <span class="tips_info">(*请输入账户名)</span>\n'+"                            </div>\n"+"                        </div>\n"+'                        <div class="option_item">\n'+'                            <div class="column_name">\n'+'                                <span class="options_name"><span class="require_icon">*</span>银行卡号：</span>\n'+"                            </div>\n"+'                            <div class="column_val">\n'+'                                <input type="text" onkeyup="this.value=this.value.replace(/\\D/g,\'\')" class="requireTrue bank_no" data-text="银行卡号" maxlength="30" value="" placeholder="请输入银行卡号" />\n'+'                                <span class="tips_info">(*请输入银行卡号)</span>\n'+"                            </div>\n"+"                        </div>\n"+'                        <div class="option_item">\n'+'                            <div class="column_name">\n'+'                                <span class="options_name"><span class="require_icon">*</span>开&nbsp;户&nbsp;行：</span>\n'+"                            </div>\n"+'                            <div class="column_val">\n'+'                                <input type="text"  class="requireTrue open_bank" data-text="开户行" maxlength="30" value="" placeholder="请输入开户行" />\n'+'                                <span class="tips_info">(*请输入开户行)</span>\n'+"                            </div>\n"+"                        </div>\n"+"                    </form>\n"+'                    <div class="btn_box text_left clearfix">\n'+'                        <a href="javascript:" class="add_sm_btn" data-type="2" data-id="'+timestamp+'">添加账户</a>\n'+'                        <a href="javascript:" class="delete_sm_btn" data-type="2" data-id="'+timestamp+'">删除账户</a>\n'+"                    </div>\n"+"                </div>";$("#recordInfo"+recordCount).after(recordStr);recordCount+=1;$("#recordCount").val(recordCount);settingBtn(".record_option")}});var settingBtn=function(target){var item=$(target);var len=item.length;if(len>1){item.each(function(i){var _this=$(this);if(i==0){var delBtnCount=Number(_this.find(".btn_box").find(".delete_sm_btn").length);if(delBtnCount<1){var id=_this.find(".add_sm_btn").data("id");if(target==".record_option"){_this.find(".btn_box").append('<a href="javascript:" class="delete_sm_btn" data-type="2" data-id="'+id+'">删除账户</a>')}else if(target==".link_option"){_this.find(".btn_box").append('<a href="javascript:" class="delete_sm_btn" data-type="1" data-id="'+id+'">删除联系人</a>')}}_this.find(".add_sm_btn").remove()}else if(i!=len-1){_this.find(".add_sm_btn").remove()}})}}}function viewImages(){var imagesParents=$(".merchants_edit");imagesParents.on("click",".img_md_operate_box .view",function(e){var e=e||window.event;e.stopPropagation();e.preventDefault();var _this=$(this);var img=_this.parents(".img_md_operate_box").siblings("img");img.click()})}function deleteImages(){var imagesParents=$(".merchants_edit");imagesParents.on("click",".img_md_operate_box .delete",function(e){var e=e||window.event;e.stopPropagation();e.preventDefault();var _this=$(this);var id=$.trim(_this.data("id"));redefineAjax({data:{file_ids:id},url:contextPath+"/api/supplier/file/delete",success:function(res){if(res.error_code==0){$alert("图片删除成功",function(){var parents=_this.parents(".img_md_box");parents[0].viewer.destroy();_this.parents(".img_item").remove();viewLargeImage(parents[0])})}else{$alert(res.error_msg)}},error:function(){$alert("图片删除异常，请稍后重试")}})})}function uploadImage(){fileUpload({maxCount:100,filesSize:2,imgFormat:["png","jpg","jpeg","svg","gif","bmp","raw","cdr"],needThumbnails:false,callback:function(btn,file){onChoose(btn,file)}});var onChoose=function(btn,file){var type=$.trim(btn.data("type"));var data=file;var fileExtension=data.name.substring(data.name.lastIndexOf("."));var fileCount=btn.parents(".img_md_box").find(".img_item").length;var filingName=$.trim(btn.parents(".option_item").find(".options_name").text()).replace(/[*:：]/gi,"");var fileName=filingName+"_"+(fileCount+1)+fileExtension;var merchantId=$.trim($("#supplierId").val());var form=new FormData;form.append("file",data);form.append("file_type",type);form.append("supplier_id",merchantId);form.append("file_name",fileName);var url=contextPath+"/api/supplier/file/upload";$.ajax({type:"post",url:url,data:form,async:false,timeout:3e5,processData:false,contentType:false,beforeSend:function(){btn.removeClass("disabled");btn.parents(".img_md_box").find(".file_upload_btn").replaceWith('<input type="file" class="file_upload_btn" name="file"  value="上传图片" style="display: none" />')},success:function(res){if(res.error_code==0){$alert("图片上传成功");var imgEle='<a href="javascript:;" class="img_item head_photo" data-type="imgBox">\n'+'             <img data-original="'+res.image_url+'" src="'+res.thumbnail+'" alt="'+fileName+'"/>\n'+'             <div class="img_md_operate_box">\n'+'             <em class="img_md_operate_btn view" data-url="'+res.image_url+'" style="margin-right: 0" title="查看"></em>\n'+(type!="99"?'<em class="img_md_operate_btn remove_btn delete" data-id="'+res.file_id+'" title="删除"></em>':"")+"             </div>\n"+"             </a>";if(type=="99"){btn.parents(".img_md_box").find(".head_photo").replaceWith(imgEle);$("#image_url").val(res.image_url);var parents=btn.parents(".img_md_box");var img=parents.find(".img_item");if(img.length>=1){parents[0].viewer.destroy()}viewLargeImage(parents[0])}else{btn.before(imgEle);var parents=btn.parents(".img_md_box");var img=parents.find(".img_item");if(img.length>1){parents[0].viewer.destroy()}viewLargeImage(parents[0])}}else{$alert("图片上传失败，请重试")}},error:function(){$alert("图片上传失败，请重试")}})}}function settingAddress(){var addrElem=$("#businessAddress");var addrResBox=$(".addr_result_box");var searchTarget=$("#mapSearch");var mapBox=$(".map_box");var listBox=$(".addr_list");var kmap=new AMap.Map("map");var noDataEle='<li class="addr_item text_center no_data">该地址下无查询数据</li>';kmap.setZoom(16);kmap.setCenter([116.341078,39.914231]);var marker=new AMap.Marker({position:[116.341078,39.914231],map:kmap});marker.setMap(kmap);AMap.plugin(["AMap.ToolBar","AMap.Autocomplete","AMap.PlaceSearch"],function(){var toolBar=new AMap.ToolBar;kmap.addControl(toolBar);var autoOptions={city:"",map:kmap};autocomplete=new AMap.Autocomplete(autoOptions);searchTarget.on("input",function(e){var e=e||window.event;e.stopPropagation();var _this=$(this);var keywords=$.trim(_this.val());if(keywords==""){mapBox.hide();listBox.hide();return}else{addrElem.siblings(".tips_info").hide()}autocomplete.search(keywords,function(status,result){addrResBox.show().find(".addr_list").show().end().find("map_box").hide();if(status=="complete"){var data=result.tips;var listEle="";for(var i=0,len=data.length;i<len;i++){if(data[i].address!=""&&data[i].address!=undefined&&data[i].location!=""&&data[i].location!=undefined){listEle+='<li class="addr_item nowrap" data-name="'+data[i].name+'" data-lat="'+data[i].location.lat+'" data-lng="'+data[i].location.lng+'">\n'+'           <div class="addr_name">'+data[i].name+"</div>\n"+'           <div class="addr_desc">'+data[i].district+data[i].address+"</div>\n"+"       </li>"}}if(listEle!=""){mapBox.hide();listBox.html("").append(listEle).show()}else{mapBox.hide();listBox.html(noDataEle).show()}}else if(status=="error"){mapBox.hide();listBox.html(noDataEle).show()}else if(status=="no_data"){mapBox.hide();listBox.html(noDataEle).show()}})})});listBox.off("click").on("click",".addr_item",function(e){var e=e||window.event;e.stopPropagation();e.preventDefault();var _this=$(this);if(_this.hasClass("no_data")){return false}var isSuccess=true;var name=_this.data("name");var lat=_this.data("lat");var lng=_this.data("lng");var addrResult=_this.find(".addr_desc").text();var newLocation=[lng,lat];AMap.service("AMap.Geocoder",function(){geocoder=new AMap.Geocoder({city:"",map:kmap});geocoder.getAddress(newLocation,function(status,result){if(status==="complete"&&result.info==="OK"){var cityCode=result.regeocode.addressComponent.citycode;var selectCityCode=$("#businessCity option:selected").data("code");if(geoCode.indexOf(cityCode)===-1){$alert("当前城市还未开通展业，请重新定位！");isSuccess=false;return}else if(cityCode!=selectCityCode){$alert("详细地址与城市不匹配，请重新定位！");isSuccess=false;return}if(isSuccess){addrElem.val(addrResult).data("geoCode",cityCode);searchTarget.val(name);$("#longitude").val(lng);$("#latitude").val(lat);mapBox.show();listBox.hide();marker.setPosition(newLocation);kmap.setCenter(newLocation)}}else{}})})});$(document).on("click",function(e){var e=e||window.event;e.stopPropagation();var target=e.target;$(target).attr("id")=="businessAddress"?false:$(".addr_result_box").hide()});$(document).on("click",".map_box,.addr_list",function(e){var e=e||window.event;e.stopPropagation();e.preventDefault()});searchTarget.on("focus click",function(e){var e=e||window.event;e.stopPropagation()});addrElem.on("click",function(e){var e=e||window.event;e.stopPropagation();e.preventDefault();var _this=$(this);var oldLocation=_this.data("location");marker.setPosition(oldLocation);kmap.setCenter(oldLocation);addrResBox.show().find(".addr_list").hide().end().find(".map_box").show()})}function resetLicenseNum(){var s=$("#recordType");var n=$("#licenseNum");s.on("change",function(){n.val("").attr("verify",1).siblings(".tips_info").hide()})}function verifyLicenseNumber(){var ele=$("#licenseNum");var IDReg=IDPATTERN;ele.on("focus",function(){var t=$(this);var isChecked=t.data("isChecked");if(isChecked==1){t.data("isChecked","0");t.attr("verify",1)}t.siblings(".tips_info").hide()});ele.on("blur",function(){var t=$(this);var v=$.trim(t.val());var licenseType=$.trim($("#recordType option:selected").val());if(licenseType==2){if(v==""){t.siblings(".tips_info").text("(*证件号码不能为空)").show();t.attr("verify",0)}else{if(!IDReg.test(v)){t.siblings(".tips_info").text("(*请输入有效证件号码)").show();t.attr("verify",0)}else{t.siblings(".tips_info").hide();t.attr("verify",1);validateIdNum(v)}}}else if(licenseType==1){validateIdNum(t)}})}function validateIdNum(t){var elem=$("#licenseNum");var lNum=$.trim(elem.val());if(lNum==""){return false}else{var isOnly=true;redefineAjax({async:false,data:{supplier_id:merchantId,id_num:lNum},url:contextPath+"/api/supplier/validate/num",success:function(res){if(res.error_code!=0){isOnly=false;$alert(res.error_msg,function(){elem.focus()})}else{t.data("isChecked","1")}},error:function(){console.error("Document number uniqueness verification failed.")}});return isOnly}}function validatePhoneNum(){var elem=$(".link_option");var phonePattern=/^1[3|4|5|8|7]\d{9}$/;elem.on("blur",".link_phone",function(){var _this=$(this);var phoneNum=$.trim(_this.val());var tips=_this.siblings(".tips_info");if(phoneNum==""){tips.text("(*手机号不能为空)").show();_this.attr("verify",0)}else if(!phonePattern.test(phoneNum)){tips.text("(*请输入正确的手机号)").show();_this.attr("verify",0)}else{tips.hide();_this.attr("verify",1)}})}function initDateAll(target){$(target).jeDate({isinitVal:false,festival:false,ishmsVal:false,format:"YYYY-MM-DD",zIndex:3e3,isClear:true});$(target).addClass("datainp wicon")}function validateBlurEmpty(){$(".merchants_edit").on("blur",".requireTrue",function(){var t=$(this);var v=$.trim(t.val());if(v==""){var tipText=t.data("text");t.siblings(".tips_info").show().text("(*"+tipText+"不能为空)");return false}});$(".merchants_edit").on("input",".requireTrue",function(){var t=$(this);var v=$.trim(t.val());if(v!=""){t.siblings(".tips_info").hide()}})}function validateEmpty(){var requireInput=$(".requireTrue");var isVerify=false;requireInput.each(function(){var t=$(this);var v=$.trim(t.val());if(v==""){var tipText=t.data("text");$alert(tipText+"不能为空");isVerify=false;return false}else{isVerify=true}});var ownType=$("#ownTypeS option:selected").val();if(ownType==1){var ownPerson=getFollowPeople();if(ownPerson.length==0){isVerify=false;$alert("请至少添加一个拥有者")}}var phones=$(".link_option .link_phone");phones.each(function(){var _this=$(this);var checked=_this.attr("verify");if(checked==0){$alert("请输入正确的手机号码");isVerify=false;return false}});var licenseNum=$("#licenseNum");var checkedLicenseNum=licenseNum.attr("verify");if(checkedLicenseNum==0){$alert("请输入正确的证件号码");isVerify=false}var isSign=$('input.isSign[type="radio"]:checked').val();var signOrg=$(".option_item.sign_org");if(isSign==1){var checkedOrg=signOrg.find('input.sign_org[type="checkbox"]:checked');if(checkedOrg.length<=0){isVerify=false;$alert("签约机构必须选择一个。")}}var checkedCityGeoCode=$("#businessCity option:selected").data("code");var addrGeoCode=addrElem.data("geoCode");if(checkedCityGeoCode!=addrGeoCode){$alert("详细地址与城市不匹配，请重新定位！");isVerify=false}return isVerify}function updateValidate(){var isVerify=null;isVerify=validateEmpty();getLinkOrRecordInfo();return isVerify}function getLinkOrRecordInfo(){var updateLinkList=[];var insertLinkList=[];var deleteLinkList=[];var updateRecordList=[];var deleteRecordList=[];var insertRecordList=[];$(".link_option.new_link").each(function(){var t=$(this);var link={supplier_id:merchantId,name:$.trim(t.find(".link_name").val()),status:1,phone:$.trim(t.find(".link_phone").val()),position_id:$.trim(t.find(".position_id option:selected").val())};insertLinkList.push(link)});if(insertLinkList.length!=0){$("#insertLinkList").val(JSON.stringify(insertLinkList))}$(".link_option.his_link").each(function(){var t=$(this);var link={id:$.trim(t.find(".link_name").data("id")),name:$.trim(t.find(".link_name").val()),status:1,phone:$.trim(t.find(".link_phone").val()),position_id:$.trim(t.find(".position_id option:selected").val())};updateLinkList.push(link)});if(updateLinkList.length!=0){$("#updateLinkList").val(JSON.stringify(updateLinkList))}$(".record_option.new_record").each(function(){var t=$(this);var accountUse=t.find('input.account_use[type="checkbox"][checked="checked"]');var accountUseArr=[];accountUse.each(function(){var _this=$(this);var v=_this.val().trim();accountUseArr.push(v)});var record={supplier_id:merchantId,account_name:$.trim(t.find(".account_name").val()),status:1,bank_no:$.trim(t.find(".bank_no").val()),open_bank:$.trim(t.find(".open_bank").val()),account_type:$.trim(t.find(".account_type option:selected").val()),account_use:accountUseArr.join(",")};insertRecordList.push(record)});if(insertRecordList.length!=0){$("#insertRecordList").val(JSON.stringify(insertRecordList))}$(".record_option.his_record").each(function(){var t=$(this);var accountUse=t.find('input.account_use[type="checkbox"][checked="checked"]');var accountUseArr=[];accountUse.each(function(){var _this=$(this);var v=_this.val().trim();accountUseArr.push(v)});var record={id:$.trim(t.find(".account_name").data("id")),account_name:$.trim(t.find(".account_name").val()),status:1,bank_no:$.trim(t.find(".bank_no").val()),open_bank:$.trim(t.find(".open_bank").val()),account_type:$.trim(t.find(".account_type option:selected").val()),account_use:accountUseArr.join(",")};updateRecordList.push(record)});if(updateRecordList!=0){$("#updateRecordList").val(JSON.stringify(updateRecordList))}}function onUpdate(){var btn=$(".edit_confirm");btn.off("click").on("click",function(){var emailpattern=EMAILPATTERN;var merchantEmail=$.trim($(".merchant_email").val());if(merchantEmail.length>0){if(!emailpattern.test(merchantEmail)){$alert("邮箱格式不正确");return false}}submitEvent(btn)})}function submitEvent(btn){btn.off("click");var isVerify=updateValidate();if(isVerify){var data=new FormData(document.getElementById("merchantsEdit"));$.ajax({type:"post",data:data,url:contextPath+"/api/supplier/edit",timeout:6e5,processData:false,contentType:false,beforeSend:function(){$("#loading").show()},success:function(res){$("#loading").hide();if(res.error_code==0){$alert("商户编辑成功",function(){locationTo({action:contextPath+markUri+"/merchants/detail",param:{supplier_id:merchantId,url:LOCALURL}})})}else{$alert(res.error_msg);onUpdate()}},error:function(){$alert("商户编辑保存失败，请稍后重试");onUpdate()}})}else{onUpdate()}}$(function(){switchStoreType();switchOwnPerson();addOwnPerson();deleteFollowPeople();deleteLinkOrRecord();addLinkOrRecord();viewLargeImage(".img_md_box");viewImages();deleteImages();uploadImage();settingAddress();validatePhoneNum();resetLicenseNum();validateBlurEmpty();onUpdate();initDateAll(".birthday")});