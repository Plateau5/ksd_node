var $toast=function(str,callback,type){var toast='<div class="toast-container" id="toast">\n'+'        <p class="toast-content '+(type&&type===1&&"error")+'">\n'+'            <span class="toast-context">'+str+"</span>\n"+"        </p>\n"+"    </div>";$("body").append(toast);$("#toast").fadeIn(600);var timer=setTimeout(function(){$("#toast").fadeOut(600,function(){callback&&callback();$(this).remove()});clearTimeout(timer)},2e3)};function goOrderDetail(){var financeId=$.trim($("#financeId").val());$(".go_order_detail").on("click",function(){locationTo({action:markUri+"/customer/loan/detail",param:{finance_id:financeId}})})}function validateBlurEmpty(){$(".docking_container").on("blur",".required",function(){var t=$(this);var readonly=t.attr("readonly");if(readonly=="readonly"){return false}var v=$.trim(t.val());if(v==""){var tipText=t.data("tips");t.siblings(".tips_info").show().find(".tips_text").text(tipText);return false}});$(".docking_container").on("input",".required",function(){var t=$(this);var v=$.trim(t.val());if(v!=""){t.css({"border-color":"#e4e4e4"}).siblings(".tips_info").hide();return true}else{return false}})}function selectListener(){$(".docking_container").on("input","select",function(){var t=$(this);var v=$.trim(t.find("option:selected").val());if(v!=""){t.css({"border-color":"#e4e4e4"})}})}function intOrFloat(ele,max){ele.on("input",function(){var reg=/^\d{0,7}(\.\d{0,2})?$/g;var _this=$(this);var val=_this.val();if(reg.test(val)){_this.siblings(".tips_info").hide();_this.attr("verify",1);return true}else{val=Number(val);if(!isNaN(val)&&val!=0){val=/\d+(\.\d{1,2})?/g.exec(val)[0];_this.val(val);_this.siblings(".tips_info").hide();_this.attr("verify",1);return true}else{_this.val(0);_this.siblings(".tips_info").show().find(".tips_text").text("只允许输入数字,最多两位小数");_this.attr("verify",0);return false}}if(val>max){_this.siblings(".tips_info").show().find(".tips_text").text("最大可输入数值为"+max+".");_this.attr("verify",0);return false}else{_this.siblings(".tips_info").hide();_this.attr("verify",1);return false}})}function checkVin(){var vinE=$("#carVin");var vinPattern=/[a-zA-Z0-9]/;if(vinE.length>0){vinE.on("input",function(){var _this=$(this);var v=_this.val().trim();_this.val("");if(vinPattern.test(v)){v=v.toUpperCase();_this.val(v);_this.siblings(".tips_info").hide();_this.attr("verify",1);return true}else{_this.val();_this.siblings(".tips_info").show().find(".tips_text").text("只允许输入数字与字母");_this.attr("verify",0);return false}});vinE.on("blur",function(){var _this=$(this);var val=_this.val().trim();var len=val.length;if(len&&len<17){_this.siblings(".tips_info").show().find(".tips_text").text("请输入17位数字与字母");_this.attr("verify",0);return false}else if(len>17){_this.siblings(".tips_info").show().find(".tips_text").text("最大只能为17位");_this.attr("verify",0);return false}else{return false}})}}function getBrand(data){var brandList=null;redefineAjax({url:contextPath+"/api/pingan/getBrand",data:data,async:false,success:function(res){if(res.error_code==0){brandList=JSON.parse(res.data)}else{return false}},error:function(){return false}});return brandList}function createBrandOption(data,type){var eleStr='<option value="">请选择</option>';for(var i=0,len=data.length;i<len;i++){if(type==1){eleStr+='<option value="'+data[i].brandId+'">'+data[i].brandName+"</option>"}else if(type==2){eleStr+='<option value="'+data[i].serialId+'">'+data[i].serialName+"</option>"}else if(type==3){eleStr+='<option data-is_can="'+data[i].is_can+'" value="'+data[i].modelId+'" data-price="'+Math.round(data[i].price*1e4)+'">'+data[i].modelName+"</option>"}}return eleStr}function isHaveWork(){var workInput=$('input[name="work"]');var workInfo=$(".work_info");workInput.on("change",function(){var _this=$(this);var v=$.trim(_this.val());if(v==1){workInfo.show()}else if(v==2){workInfo.hide()}})}function clearWorkInfo(){var workInfo=$(".work_info");if(workInfo.length>0&&workInfo.is(":hidden")){var workInput=workInfo.find("input");var workSelect=workInfo.find("select");workInput.each(function(){var _this=$(this);_this.val("").attr("verify",1).attr("disabled","disabled")});workSelect.each(function(){var _this=$(this);_this.val("").attr("disabled","disabled")})}}function isMarriage(){var marriageInfo=$("#renterMarriage");var spouseInfo=$(".spouse_info");var parentInfo=$(".parent_info");marriageInfo.on("change",function(){var _this=$(this);var v=$.trim(_this.find("option:selected").val());if(v==2){spouseInfo.show();parentInfo.hide()}else{spouseInfo.hide();parentInfo.show()}})}function verifyGender(){var IDNum=$.trim($('input[name="IDnum"]').val());var gender=$(".option_item.gender");var genderH=$(".gender_h");if(IDNum){if(IDNum.length==18){var seventeenthNum=IDNum.slice(16,17).number()}else if(IDNum.length==15){var seventeenthNum=IDNum.slice(13,14).number()}if(seventeenthNum%2===1){gender.find('input[type="radio"].male').prop("checked",true);gender.find('input[type="radio"].female').prop("checked",false);genderH.val(1)}else{gender.find('input[type="radio"].male').prop("checked",false);gender.find('input[type="radio"].female').prop("checked",true);genderH.val(2)}}}function setBirthday(){var IDNum=$.trim($('input[name="IDnum"]').val());var birthday=$(".birthday");if(IDNum){if(IDNum.length==18){var birthdayNum=IDNum.slice(6,14).number();birthday.val(birthdayNum)}else if(IDNum.length==15){var birthdayNum=IDNum.slice(6,12).number();birthday.val(birthdayNum)}}}function verifyEmpty(){var isAleary=true;var inputs=$('form[role="saveForm"] input.required').not('input[disabled="disabled"]');var select=$('form[role="saveForm"] select').not('selected[disabled="disabled"]');var parent=$(".parent_info");var spouse=$(".spouse_info");var workInfo=$(".work_info");inputs.each(function(){var _this=$(this);var _parent=_this.parents(".parent_info");var _spouse=_this.parents(".spouse_info");var _workInfo=_this.parents(".work_info");var v=$.trim(_this.val());if(_parent.length<=0&&_spouse.length<=0&&_workInfo.length<=0||_spouse.length>0&&!spouse.is(":hidden")||_parent.length>0&&!parent.is(":hidden")||_workInfo.length>0&&!workInfo.is(":hidden")){if(!v){isAleary=false;_this.css({"border-color":"rgb(251, 39, 65)"})}else{var roulePass=_this.attr("verify");if(roulePass==0){isAleary=false;_this.css({"border-color":"rgb(251, 39, 65)"})}}}});select.each(function(){var _this=$(this);var selected=_this.find("option:selected");var v=$.trim(selected.val());var _parent=_this.parents(".parent_info");var _spouse=_this.parents(".spouse_info");var _workInfo=_this.parents(".work_info");if(_parent.length<=0&&_spouse.length<=0&&_workInfo.length<=0||_spouse.length>0&&!spouse.is(":hidden")||_parent.length>0&&!parent.is(":hidden")||_workInfo.length>0&&!workInfo.is(":hidden")){if(!v&v!="0"){isAleary=false;_this.css({"border-color":"rgb(251, 39, 65)"})}}});return isAleary}function uploadImage(){fileUpload({maxCount:1,filesSize:10,fileFormat:["png","jpg","jpeg"],needThumbnails:false,callback:function(btn){onChoose(btn)}});var onChoose=function(btn){var type=$.trim(btn.data("type"));var data=btn.parents(".file_upload").find(".file_upload_btn")[0].files[0];var form=new FormData;form.append("file",data);var url=contextPath+"/api/docking/file/upload";$.ajax({type:"post",url:url,data:form,async:true,timeout:3e5,processData:false,contentType:false,beforeSend:function(){$("#loading").show();btn.removeClass("disabled");btn.parents(".img_md_box").find(".file_upload_btn").replaceWith('<input type="file" class="file_upload_btn" name="file"  value="上传图片" style="display: none" />')},complete:function(){},success:function(res){$("#loading").hide();if(res.error_code==0){$alert("图片上传成功");var imgEle='<a href="javascript:;" class="img_item" data-type="imgBox" data-id="'+res.file_id+'">'+'             <img data-original="'+res.url+'" src="'+res.thumbnail_url+'"/>\n'+'             <div class="img_md_operate_box">\n'+'             <em class="img_md_operate_btn view" data-url="'+res.url+'" style="margin-right: 0" title="查看"></em>\n'+(type!="2"?'<em class="img_md_operate_btn delete" data-id="'+res.file_id+'" title="删除"></em>':"")+"             </div>\n"+"             </a>";if(type=="2"){var parents=btn.parents(".img_md_box");var img=parents.find(".img_item");if(img.length<=0){btn.before(imgEle)}else{btn.parents(".img_md_box").find(".img_item").replaceWith(imgEle)}$("#image_url").val(res.image_url);if(img.length>=1){parents[0].viewer.destroy()}viewLargeImage(parents[0])}else{btn.before(imgEle);var parents=btn.parents(".img_md_box");var img=parents.find(".img_item");if(img.length>1){parents[0].viewer.destroy()}viewLargeImage(parents[0])}}else{$alert("图片上传失败，请重试")}},error:function(){$("#loading").hide();$alert("图片上传失败，请重试")}})}}function viewImages(){var imagesParents=$(".docking_container");imagesParents.on("click",".img_md_operate_box .view",function(e){var e=e||window.event;e.stopPropagation();e.preventDefault();var _this=$(this);var img=_this.parents(".img_md_operate_box").siblings("img");img.click()})}function deleteImages(){var imagesParents=$(".docking_container");imagesParents.on("click",".img_md_operate_box .delete",function(e){var e=e||window.event;e.stopPropagation();e.preventDefault();var _this=$(this);var parent=_this.parents("a.img_item");parent.remove()})}function clearSpouseOrParentInfo(){var spouseInfo=$(".spouse_info");var parentInfo=$(".parent_info");if(spouseInfo.length>0||parentInfo.length>0){var elem=null;if(spouseInfo.is(":hidden")){elem=spouseInfo}else if(parentInfo.is(":hidden")){elem=parentInfo}var input=elem.find("input");var select=elem.find("select");input.each(function(){$(this).val("").attr("disabled","disabled")});select.each(function(){$(this).val("").attr("disabled","disabled")})}}function bindSubmitEvent(){var btn=$("#saveAndGoNext");btn.off("click").on("click",function(){var t=$(this);var nextStep=$.trim(t.data("next"));var url=$.trim(t.data("url"));saveAndGoNext(t,nextStep,url)})}function saveAndGoNext(btn,nextPath,url){var financeId=$.trim($("#financeId").val());var queryType=$.trim($("#queryType").val());var nextQueryType=$("#nextQueryType").val().trim().number();var preCode=$.trim($("#preCode").val());var navigation=$("#navigation").val().trim();var nodeUrl=$("#nodeUrl").val().trim();var userName=$("#userName").val().trim();var verifyPass=verifyEmpty();if(!ISCARINFO||ISCARINFO===undefined){var verifyAmountPass=true}else{var verifyAmountPass=verifyAmount()}if(verifyPass&&verifyAmountPass){btn.off("click");clearWorkInfo();clearSpouseOrParentInfo();var form=$('form[role="saveForm"]')[0];var data=new FormData(form);$.ajax({type:"POST",url:url,data:data,contentType:false,processData:false,timeout:1e4,beforeSend:function(){$("#loading").show()},complete:function(){},success:function(res){$("#loading").hide();if(res.error_code==0){$toast("保存成功",function(){locationTo({action:nextPath,param:{finance_id:financeId,query_type:nextQueryType,preCode:preCode,navigation:navigation,nodeUrl:nodeUrl,userName:userName}})})}else{$alert(res.error_msg);bindSubmitEvent()}},error:function(){$("#loading").hide();$alert("提交保存失败，请稍后重试。");bindSubmitEvent()}})}else{$alert("该页面还有资料未填写完整或错误，请先更正后再保存")}}function calcRepaymentPlan(financeAmount,interestRate,rentDue){interestRate=interestRate/100;var data={interestRateAmount:[],principalAmount:[]};var monthRent=Number(interestRate/12);data.eachRent=(financeAmount*monthRent*Math.pow(1+monthRent,rentDue)/(Math.pow(1+monthRent,rentDue)-1)).toFixed(2).number();for(var i=1;i<=rentDue;i++){var a=(financeAmount*monthRent*(Math.pow(1+monthRent,rentDue)-Math.pow(1+monthRent,i-1))/(Math.pow(1+monthRent,rentDue)-1)).toFixed(2).number();var b=(financeAmount*monthRent*Math.pow(1+monthRent,i-1)/(Math.pow(1+monthRent,rentDue)-1)).toFixed(2).number();a=formatNum(a);b=formatNum(b);data.interestRateAmount.push(a);data.principalAmount.push(b)}return data}function createRepaymentPlanTable(financeAmount,interestRate,rentDue){var product=$("#productName");var finance=$("#finance");var rentDueE=$("#rentDue");var eachRentE=$("#eachRent");var rentTime=$("#rentTime").val().trim();var data=calcRepaymentPlan(financeAmount,interestRate,rentDue);eachRentE.val(data.eachRent).siblings(".value_text").find(".value").text(data.eachRent);var ele="";var timeArr=rentTime.split("-");timeArr[0]=timeArr[0].number();timeArr[1]=timeArr[1].number();var month=timeArr[1],year=timeArr[0];for(var i=1;i<=rentDue;i++){month+=1;if(month==12){year+=1;month=1}ele+="<tr>\n"+"                                <td>"+year+"-"+(month<10?"0"+month:month)+"-15</td>\n"+"                                <td>"+i+"</td>\n"+"                                <td>"+data.eachRent+"</td>\n"+"                                <td>"+data.interestRateAmount[i-1]+"</td>\n"+"                                <td>"+data.principalAmount[i-1]+"</td>\n"+"                            </tr>"}var table=$("#repaymentPlanTable");table.find("tbody").html(ele)}function bindImageSubmitEvent(){var btn=$("#fileConfirm");btn.off("click").on("click",function(){var t=$(this);var nextStep=$.trim(t.data("next"));var url=$.trim(t.data("url"));fileSaveAndGoNext(t,nextStep,url)})}function verifyImgPass(){var isPass=true;var elem=$(".require_icon").not(".exp_require");elem.each(function(){var _this=$(this);var imgs=_this.parents(".file_option_item").find(".img_item");if(imgs.length<=0){isPass=false;return false}});if(groupId){var groupIdArr=groupId.split(",");for(var i=0,len=groupIdArr.length;i<len;i++){var groupNameArr=[];var groupElems=$('.file_option_item[group_id="'+groupIdArr[i]+'"]');var imgFiles=0;groupElems.each(function(){var _this=$(this);var title=_this.data("name");var imgs=_this.find(".img_item").length;imgFiles+=imgs;if(groupNameArr.indexOf(title)===-1){groupNameArr.push(title)}});if(imgFiles===0){$alert("【"+groupNameArr.join("、")+"】这"+groupNameArr.length+"项必须填写一项。");isPass=false;break}}}return isPass}function fileSaveAndGoNext(btn,nextPath,url){var queryType=$.trim($("#queryType").val());var nextQueryType=$("#nextQueryType").val().trim().number();var type=$.trim(btn.data("type")).number();var navigation=$("#navigation").val().trim();var nodeUrl=$("#nodeUrl").val().trim();var userName=$("#userName").val().trim();var fileData=getData(type);fileData=JSON.stringify(fileData);var isValidate=verifyImgPass();var financeId=$.trim($("#financeId").val());if(isValidate){btn.off("click");$.ajax({type:"POST",url:url,data:{finance_id:financeId,data:fileData},timeout:1e4,beforeSend:function(){$("#loading").show()},complete:function(){},success:function(res){$("#loading").hide();if(res.error_code==0){$toast("保存成功",function(){locationTo({action:nextPath,param:{finance_id:financeId,query_type:nextQueryType,navigation:navigation,nodeUrl:nodeUrl,userName:userName}})})}else{$alert(res.error_msg);bindSubmitEvent()}},error:function(){$alert("提交保存失败，请稍后重试。");bindSubmitEvent()}})}else{$alert("该页面还有必传材料未上传，请先上传完再保存")}function getData(type){var data=[];var form=$('form[role="fileSaveForm"]');var imgs=form.find(".img_md_box .img_item");var materials=form.find(".credit_info");if(type===1){imgs.each(function(){var o={};var _this=$(this);var parentBox=_this.parent(".img_md_box");o.file_id=$.trim(_this.data("id"));o.file_type=$.trim(parentBox.data("file_type"));o.file_name=$.trim(parentBox.data("file_name"));o.material_type=$.trim(parentBox.data("material_type"));o.material_name=$.trim(parentBox.data("material_name"));data.push(o)})}else if(type===2){materials.each(function(){var _this=$(this);var o={};var creditImg=_this.find(".credit_img .img_item");var groupPhotoImg=_this.find(".group_img .img_item");o.material_type=$.trim(_this.data("material_type"));o.authFileUid=$.trim(creditImg.data("id"));o.groupPhotoUid=$.trim(groupPhotoImg.data("id"));data.push(o)})}return data}}function getAddressData(){var data=null;redefineAjax({url:contextPath+"/api/pingan/listprovincecity",async:false,success:function(res){if(res.error_code==0){data=res}else{}},error:function(e){throw new Error("Get address data error.")}});return data}function getOccupation(data){var empOccupation=$("select.occupation");var eleStr='<option value="">请选择</option>';for(var i=0,len=data.length;i<len;i++){eleStr+='<option value="'+data[i].id+'">'+data[i].value+"</option>"}empOccupation.each(function(){var _this=$(this);_this.html(eleStr)})}function chooseSelectOccoupation(){var occupationKey=$("input.occupationKey");occupationKey.each(function(){var _this=$(this);var v=_this.val().trim();if(v){var sOccupation=_this.siblings("select.occupation");sOccupation.val(v)}})}function setOccupationName(){var empOccupation=$("select.occupation");empOccupation.on("change",function(){var _this=$(this);var opt=_this.find("option:selected");var name=opt.text().trim();var nameInput=_this.siblings(".occupationName");nameInput.val(name)})}function getProvince(data){var province=$("select.province");var optStr='<option value="">请选择</option>';for(var i=0,len=data.length;i<len;i++){optStr+='<option value="'+data[i].p_id+'">'+data[i].p_name+"</option>"}province.each(function(){var _this=$(this);_this.html(optStr)})}function getCity(pid,data){var cityList=jsonsql.query("select * from json where (p_id=="+pid+")",data);var optStr='<option value="">请选择</option>';for(var i=0,len=cityList.length;i<len;i++){optStr+='<option value="'+cityList[i].c_id+'">'+cityList[i].c_name+"</option>"}return optStr}function chooseSelectedCity(){var selectedProvince=$(".provinceKey");selectedProvince.each(function(){var _this=$(this);var v=_this.val().trim();if(v){v=v.number();var pSelect=_this.siblings(".province");pSelect.val(v);var provinceType=pSelect.data("type");var dataCity=cityData.data_city;var citys=getCity(v,dataCity);$("#"+provinceType+"City").html(citys);var selectedCityValue=_this.siblings(".cityKey").val().trim();var cSelect=_this.siblings(".city");cSelect.val(selectedCityValue)}})}function createCityList(){var province=$("select.province");var citys="";var provinceType="";province.on("change",function(){var _this=$(this);var option=_this.find("option:selected");var v=$.trim(option.val()).number();provinceType=_this.data("type");citys=getCity(v,cityData.data_city);$("#"+provinceType+"City").html(citys)})}function setAddressName(){var citySelect=$("select.province, select.city");citySelect.on("change",function(){var _this=$(this);var opt=_this.find("option:selected");var name=opt.text().trim();var type=_this.data("name");var nameInput=_this.siblings("."+type+"Name");nameInput.val(name)})}function goDockingHome(selector){var financeId=$.trim($("#financeId").val());var userName=$("#userName").val().trim();var homeUrl=$(selector).data("href");var navigation=$("#navigation").val().trim();var nodeUrl=$("#nodeUrl").val().trim();var userName=$("#userName").val().trim();$(selector).on("click",function(){locationTo({action:homeUrl,param:{finance_id:financeId,userName:userName,navigation:navigation,nodeUrl:nodeUrl,userName:userName}})})}$(function(){goOrderDetail();goDockingHome(".go_docking_home");selectListener()});